<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from docs.openstack.org/image-guide/centos-image.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Jan 2017 11:15:35 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>

    <title>OpenStack Docs: Example: CentOS image</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link href="_static/css/bootstrap.min.css" rel="stylesheet">

<!-- Pygments CSS -->
<link href="_static/css/native.css" rel="stylesheet">

<!-- Fonts -->
<link href="../../maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>

<!-- Custom CSS -->
<link href="_static/css/combined.css" rel="stylesheet">
<link href="_static/css/styles.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
  


<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','../../www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17511903-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

  </head>
  <body>
<nav class="navbar navbar-default inner" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="brand-wrapper">
        <a class="navbar-brand" href="http://docs.openstack.org/"></a>
      </div>
      <div class="search-icon show"><i class="fa fa-search"></i> Search</div></div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <div class="search-container tiny">
        <div id="gcse">
          <script type="text/javascript">
(function() {
  var cx = '000108871792296872333:noj9nikm74i';
  var gcse = document.createElement('script');
  gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//www.google.com/cse/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();
          </script>
          <gcse:search gname="standard"></gcse:search>
        </div>
        <i class="fa fa-times close-search"></i>
      </div>
      <ul class="nav navbar-nav navbar-main show">
        <li>
          <div id="gcse-mobile">
            <gcse:search gname="mobile"></gcse:search>
          </div>
        </li>
        <li>
          <a href="http://www.openstack.org/software/" class="drop" id="dropdownMenuSoftware">Software <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuSoftware">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/project-navigator/">Project Navigator</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sample-configs/">Sample Configs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/start/">Get Started</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/roadmap/">Roadmap</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/latest-release/">Latest Release</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sourcecode/">Source Code</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/user-stories/" class="drop" id="dropdownMenuUsers">Users <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuUsers">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/user-stories/">Overview</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/enterprise/">OpenStack in the Enterprise</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/appdev/">Application Developers</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org/">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/surveys/landing">User Survey</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/community/" class="drop" id="dropdownMenuCommunity">Community <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuCommunity">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/">Welcome! Start Here</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/">OpenStack Foundation</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://wiki.openstack.org/">OpenStack Wiki</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://groups.openstack.org/">User Groups</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/speakers/">Speakers Bureau</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/companies/">Supporting Companies</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/jobs/">Jobs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/join/">Join The Community</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/marketplace/">Marketplace</a>
        </li>
        <li>
          <a href="http://www.openstack.org/events/" class="drop" id="dropdownMenuEvents">Events <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/events/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/summit/">The OpenStack Summit</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/events/">More OpenStack Events</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/events/#openstack_days">OpenStack Days</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/learn/" class="drop" id="dropdownMenuLearn">Learn <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/marketplace/training/">Training</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org/">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://ask.openstack.org/">Ask a Technical Question</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/news/">News</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/blog/">Blog</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/videos/summits">Summit Videos</a></li>
          </ul>
        </li>
        <li>
          <a href="http://docs.openstack.org/">Docs</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
    <div class="container docs-book-wrapper">
      <div class="row">
        <div class="col-lg-9 col-md-8 col-sm-8 col-lg-push-3 col-md-push-4 col-sm-push-4">
<div class="row">
  <div class="col-lg-8">
    <h2>Example: CentOS image</h2>
  </div>
  <div class="docs-actions">
    
    <a href="virt-install.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Use virt-install and connect by using a local VNC client"></i></a>
    
    
    <a href="ubuntu-image.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Example: Ubuntu image"></i></a>
    
    <a id="logABugLink1" href="#" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
  </div>
</div>
          <div class="row docs-byline">
            <div class="docs-updated">updated: 2016-12-30 18:30</div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="docs-top-contents">

<h5><a href="index-2.html">Contents</a></h5>
<ul>
<li><a class="reference internal" href="#">Example: CentOS image</a><ul>
<li><a class="reference internal" href="#download-a-centos-install-iso">Download a CentOS install ISO</a></li>
<li><a class="reference internal" href="#start-the-installation-process">Start the installation process</a></li>
<li><a class="reference internal" href="#step-through-the-installation">Step through the installation</a><ul>
<li><a class="reference internal" href="#change-the-ethernet-status">Change the Ethernet status</a></li>
<li><a class="reference internal" href="#point-the-installer-to-a-centos-web-server">Point the installer to a CentOS web server</a></li>
<li><a class="reference internal" href="#storage-devices">Storage devices</a></li>
<li><a class="reference internal" href="#hostname">Hostname</a></li>
<li><a class="reference internal" href="#partition-the-disks">Partition the disks</a></li>
<li><a class="reference internal" href="#select-installation-option">Select installation option</a></li>
<li><a class="reference internal" href="#detach-the-cd-rom-and-reboot">Detach the CD-ROM and reboot</a></li>
<li><a class="reference internal" href="#log-in-to-newly-created-image">Log in to newly created image</a></li>
</ul>
</li>
<li><a class="reference internal" href="#install-the-acpi-service">Install the ACPI service</a></li>
<li><a class="reference internal" href="#configure-to-fetch-metadata">Configure to fetch metadata</a></li>
<li><a class="reference internal" href="#use-cloud-init-to-fetch-the-public-key">Use cloud-init to fetch the public key</a></li>
<li><a class="reference internal" href="#write-a-script-to-fetch-the-public-key-if-no-cloud-init">Write a script to fetch the public key (if no cloud-init)</a></li>
<li><a class="reference internal" href="#disable-the-zeroconf-route">Disable the zeroconf route</a></li>
<li><a class="reference internal" href="#configure-console">Configure console</a></li>
<li><a class="reference internal" href="#shut-down-the-instance">Shut down the instance</a></li>
<li><a class="reference internal" href="#clean-up-remove-mac-address-details">Clean up (remove MAC address details)</a></li>
<li><a class="reference internal" href="#undefine-the-libvirt-domain">Undefine the libvirt domain</a></li>
<li><a class="reference internal" href="#image-is-complete">Image is complete</a></li>
</ul>
</li>
</ul>

              </div>
              <div class="docs-body">

  <div class="section" id="example-centos-image">
<h1>Example: CentOS image<a class="headerlink" href="#example-centos-image" title="Permalink to this headline">¶</a></h1>
<p>This example shows you how to install a CentOS image and focuses
mainly on CentOS 7. Because the CentOS installation process
might differ across versions, the installation steps might
differ if you use a different version of CentOS.</p>
<div class="section" id="download-a-centos-install-iso">
<h2>Download a CentOS install ISO<a class="headerlink" href="#download-a-centos-install-iso" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Navigate to the <a class="reference external" href="https://www.centos.org/download/mirrors/">CentOS mirrors</a> page.</li>
<li>Click one of the <code class="docutils literal"><span class="pre">HTTP</span></code> links in the right-hand
column next to one of the mirrors.</li>
<li>Click the folder link of the CentOS version that
you want to use. For example, <code class="docutils literal"><span class="pre">7/</span></code>.</li>
<li>Click the <code class="docutils literal"><span class="pre">isos/</span></code> folder link.</li>
<li>Click the <code class="docutils literal"><span class="pre">x86_64/</span></code> folder link for 64-bit images.</li>
<li>Click the netinstall ISO image that you want to download.
For example, <code class="docutils literal"><span class="pre">CentOS-7-x86_64-NetInstall-1511.iso</span></code> is a good
choice because it is a smaller image that downloads missing
packages from the Internet during installation.</li>
</ol>
</div>
<div class="section" id="start-the-installation-process">
<h2>Start the installation process<a class="headerlink" href="#start-the-installation-process" title="Permalink to this headline">¶</a></h2>
<p>Start the installation process using either the <strong class="command">virt-manager</strong>
or the <strong class="command">virt-install</strong> command as described in the previous section.
If you use the <strong class="command">virt-install</strong> command, do not forget to connect your
VNC client to the virtual machine.</p>
<p>Assume that:</p>
<ul class="simple">
<li>The name of your virtual machine image is <code class="docutils literal"><span class="pre">centos</span></code>;
you need this name when you use <strong class="command">virsh</strong> commands
to manipulate the state of the image.</li>
<li>You saved the netinstall ISO image to the <code class="docutils literal"><span class="pre">/data/isos</span></code> directory.</li>
</ul>
<p>If you use the <strong class="command">virt-install</strong> command, the commands should look
something like this:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> qemu-img create -f qcow2 /tmp/centos.qcow2 10G
<span class="gp">#</span> virt-install --virt-type kvm --name centos --ram <span class="m">1024</span> <span class="se">\</span>
<span class="go">  --disk /tmp/centos.qcow2,format=qcow2 \</span>
<span class="go">  --network network=default \</span>
<span class="go">  --graphics vnc,listen=0.0.0.0 --noautoconsole \</span>
<span class="go">  --os-type=linux --os-variant=rhel7 \</span>
<span class="go">  --location=/data/isos/CentOS-7-x86_64-NetInstall-1511.iso</span>
</pre></div>
</div>
</div>
<div class="section" id="step-through-the-installation">
<h2>Step through the installation<a class="headerlink" href="#step-through-the-installation" title="Permalink to this headline">¶</a></h2>
<p>At the initial Installer boot menu, choose the
<span class="guilabel">Install CentOS 7</span> option.
Step through the installation prompts. Accept the defaults.</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/centos-install.png"><img alt="_images/centos-install.png" src="_images/centos-install.png" style="width: 100%;" /></a>
</div>
<div class="section" id="change-the-ethernet-status">
<h3>Change the Ethernet status<a class="headerlink" href="#change-the-ethernet-status" title="Permalink to this headline">¶</a></h3>
<p>The default Ethernet setting is <code class="docutils literal"><span class="pre">OFF</span></code>. Change the setting of
the Ethernet form <code class="docutils literal"><span class="pre">OFF</span></code> to <code class="docutils literal"><span class="pre">ON</span></code>. In particular, ensure that
<code class="docutils literal"><span class="pre">IPv4</span> <span class="pre">Settings'</span> <span class="pre">Method</span></code> is <code class="docutils literal"><span class="pre">Automatic</span> <span class="pre">(DHCP)</span></code>, which is the
default.</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/centos-tcpip.png"><img alt="_images/centos-tcpip.png" src="_images/centos-tcpip.png" style="width: 100%;" /></a>
</div>
</div>
<div class="section" id="point-the-installer-to-a-centos-web-server">
<h3>Point the installer to a CentOS web server<a class="headerlink" href="#point-the-installer-to-a-centos-web-server" title="Permalink to this headline">¶</a></h3>
<p>Depending on the version of CentOS, the net installer requires
the user to specify either a URL or the web site and
a CentOS directory that corresponds to one of the CentOS mirrors.
If the installer asks for a single URL, a valid URL might be
<code class="docutils literal"><span class="pre">http://mirror.umd.edu/centos/7/os/x86_64</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Consider using other mirrors as an alternative to <code class="docutils literal"><span class="pre">mirror.umd.edu</span></code>.</p>
</div>
<div class="figure">
<a class="reference internal image-reference" href="_images/centos-url-setup.png"><img alt="_images/centos-url-setup.png" src="_images/centos-url-setup.png" style="width: 100%;" /></a>
</div>
<p>If the installer asks for web site name and CentOS directory
separately, you might enter:</p>
<ul class="simple">
<li>Web site name: <code class="docutils literal"><span class="pre">mirror.umd.edu</span></code></li>
<li>CentOS directory: <code class="docutils literal"><span class="pre">centos/7/os/x86_64</span></code></li>
</ul>
<p>See <a class="reference external" href="https://www.centos.org/download/mirrors/">CentOS mirror page</a>
to get a full list of mirrors, click on the <code class="docutils literal"><span class="pre">HTTP</span></code> link
of a mirror to retrieve the web site name of a mirror.</p>
</div>
<div class="section" id="storage-devices">
<h3>Storage devices<a class="headerlink" href="#storage-devices" title="Permalink to this headline">¶</a></h3>
<p>If prompted about which type of devices your installation uses,
choose <span class="guilabel">Virtio Block Device</span>.</p>
</div>
<div class="section" id="hostname">
<h3>Hostname<a class="headerlink" href="#hostname" title="Permalink to this headline">¶</a></h3>
<p>The installer may ask you to choose a host name.
The default (<code class="docutils literal"><span class="pre">localhost.localdomain</span></code>) is fine.
You install the <code class="docutils literal"><span class="pre">cloud-init</span></code> package later,
which sets the host name on boot when a new instance
is provisioned using this image.</p>
</div>
<div class="section" id="partition-the-disks">
<h3>Partition the disks<a class="headerlink" href="#partition-the-disks" title="Permalink to this headline">¶</a></h3>
<p>There are different options for partitioning the disks.
The default installation uses LVM partitions, and creates
three partitions (<code class="docutils literal"><span class="pre">/boot</span></code>, <code class="docutils literal"><span class="pre">/</span></code>, <code class="docutils literal"><span class="pre">swap</span></code>), which works fine.
Alternatively, you might want to create a single ext4
partition that is mounted to <code class="docutils literal"><span class="pre">/</span></code>, which also works fine.</p>
<p>If unsure, use the default partition scheme for the installer
because no scheme is better than another.</p>
</div>
<div class="section" id="select-installation-option">
<h3>Select installation option<a class="headerlink" href="#select-installation-option" title="Permalink to this headline">¶</a></h3>
<p>Step through the installation, using the default options.
The simplest thing to do is to choose the <code class="docutils literal"><span class="pre">Minimal</span> <span class="pre">Install</span></code>
install, which installs an SSH server.</p>
</div>
<div class="section" id="detach-the-cd-rom-and-reboot">
<h3>Detach the CD-ROM and reboot<a class="headerlink" href="#detach-the-cd-rom-and-reboot" title="Permalink to this headline">¶</a></h3>
<p>When the installation has completed, the
<span class="guilabel">Congratulations, your CentOS installation is complete</span>
screen appears.</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/centos-complete.png"><img alt="_images/centos-complete.png" src="_images/centos-complete.png" style="width: 100%;" /></a>
</div>
<p>To eject a disk by using the <strong class="command">virsh</strong> command,
libvirt requires that you attach an empty disk at the same target
that the CDROM was previously attached, which should be <code class="docutils literal"><span class="pre">hdc</span></code>.
You can confirm the appropriate target using the
<strong class="command">virsh dumpxml vm-image</strong> command.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> virsh dumpxml centos
<span class="go">&lt;domain type=&#39;kvm&#39; id=&#39;19&#39;&gt;</span>
<span class="go">  &lt;name&gt;centos&lt;/name&gt;</span>
<span class="go">...</span>
<span class="go">    &lt;disk type=&#39;block&#39; device=&#39;cdrom&#39;&gt;</span>
<span class="go">      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;</span>
<span class="go">      &lt;target dev=&#39;hdc&#39; bus=&#39;ide&#39;/&gt;</span>
<span class="go">      &lt;readonly/&gt;</span>
<span class="go">      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;1&#39; target=&#39;0&#39; unit=&#39;0&#39;/&gt;</span>
<span class="go">    &lt;/disk&gt;</span>
<span class="go">...</span>
<span class="go">&lt;/domain&gt;</span>
</pre></div>
</div>
<p>Run the following commands from the host to eject the disk
and reboot using <code class="docutils literal"><span class="pre">virsh</span></code>, as root. If you are using <code class="docutils literal"><span class="pre">virt-manager</span></code>,
the commands below will work, but you can also use the GUI to detach
and reboot it by manually stopping and starting.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> virsh attach-disk --type cdrom --mode <span class="nb">readonly</span> centos <span class="s2">&quot;&quot;</span> hdc
<span class="gp">#</span> virsh reboot centos
</pre></div>
</div>
</div>
<div class="section" id="log-in-to-newly-created-image">
<h3>Log in to newly created image<a class="headerlink" href="#log-in-to-newly-created-image" title="Permalink to this headline">¶</a></h3>
<p>When you boot for the first time after installation,
you might be prompted about authentication tools.
Select <span class="guilabel">Exit</span>. Then, log in as root.</p>
</div>
</div>
<div class="section" id="install-the-acpi-service">
<h2>Install the ACPI service<a class="headerlink" href="#install-the-acpi-service" title="Permalink to this headline">¶</a></h2>
<p>To enable the hypervisor to reboot or shutdown an instance,
you must install and run the <code class="docutils literal"><span class="pre">acpid</span></code> service on the guest system.</p>
<p>Run the following commands inside the CentOS guest to install the
ACPI service and configure it to start when the system boots:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> yum install acpid
<span class="gp">#</span> systemctl <span class="nb">enable</span> acpid
</pre></div>
</div>
</div>
<div class="section" id="configure-to-fetch-metadata">
<h2>Configure to fetch metadata<a class="headerlink" href="#configure-to-fetch-metadata" title="Permalink to this headline">¶</a></h2>
<p>An instance must interact with the metadata service to perform
several tasks on start up. For example, the instance must get
the ssh public key and run the user data script. To ensure that
the instance performs these tasks, use one of these methods:</p>
<ul class="simple">
<li>Install a <code class="docutils literal"><span class="pre">cloud-init</span></code> RPM, which is a port of the Ubuntu
<a class="reference external" href="https://launchpad.net/cloud-init">cloud-init</a> package.
This is the recommended approach.</li>
<li>Modify the <code class="docutils literal"><span class="pre">/etc/rc.local</span></code> file to fetch desired information from
the metadata service, as described in the next section.</li>
</ul>
</div>
<div class="section" id="use-cloud-init-to-fetch-the-public-key">
<h2>Use cloud-init to fetch the public key<a class="headerlink" href="#use-cloud-init-to-fetch-the-public-key" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">cloud-init</span></code> package automatically fetches the public key
from the metadata server and places the key in an account.
You can install <code class="docutils literal"><span class="pre">cloud-init</span></code> inside the CentOS guest by
adding the EPEL repo:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> yum install epel-release.noarch
<span class="gp">#</span> yum install cloud-init
</pre></div>
</div>
<p>The account varies by distribution. On Ubuntu-based virtual machines,
the account is called <code class="docutils literal"><span class="pre">ubuntu</span></code>. On Fedora-based virtual machines,
the account is called <code class="docutils literal"><span class="pre">ec2-user</span></code>.</p>
<p>You can change the name of the account used by <code class="docutils literal"><span class="pre">cloud-init</span></code>
by editing the <code class="docutils literal"><span class="pre">/etc/cloud/cloud.cfg</span></code> file and adding a line
with a different user. For example, to configure <code class="docutils literal"><span class="pre">cloud-init</span></code>
to put the key in an account named <code class="docutils literal"><span class="pre">admin</span></code>, add this line
to the configuration file:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">user: admin</span>
</pre></div>
</div>
</div>
<div class="section" id="write-a-script-to-fetch-the-public-key-if-no-cloud-init">
<h2>Write a script to fetch the public key (if no cloud-init)<a class="headerlink" href="#write-a-script-to-fetch-the-public-key-if-no-cloud-init" title="Permalink to this headline">¶</a></h2>
<p>If you are not able to install the <code class="docutils literal"><span class="pre">cloud-init</span></code> package in your
image, to fetch the ssh public key and add it to the root account,
edit the <code class="docutils literal"><span class="pre">/etc/rc.d/rc.local</span></code> file and add the following lines
before the line <code class="docutils literal"><span class="pre">touch</span> <span class="pre">/var/lock/subsys/local</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">[</span> ! -d /root/.ssh <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  mkdir -p /root/.ssh
  chmod <span class="m">700</span> /root/.ssh
<span class="k">fi</span>

<span class="c1"># Fetch public key using HTTP</span>
<span class="nv">ATTEMPTS</span><span class="o">=</span>30
<span class="nv">FAILED</span><span class="o">=</span>0
<span class="k">while</span> <span class="o">[</span> ! -f /root/.ssh/authorized_keys <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
  curl -f http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key <span class="se">\</span>
    &gt; /tmp/metadata-key 2&gt;/dev/null
  <span class="k">if</span> <span class="o">[</span> <span class="se">\$</span>? -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    cat /tmp/metadata-key &gt;&gt; /root/.ssh/authorized_keys
    chmod <span class="m">0600</span> /root/.ssh/authorized_keys
    restorecon /root/.ssh/authorized_keys
    rm -f /tmp/metadata-key
    <span class="nb">echo</span> <span class="s2">&quot;Successfully retrieved public key from instance metadata&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;*****************&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;AUTHORIZED KEYS&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;*****************&quot;</span>
    cat /root/.ssh/authorized_keys
    <span class="nb">echo</span> <span class="s2">&quot;*****************&quot;</span>
  <span class="k">fi</span>
<span class="k">done</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Some VNC clients replace the colon (<code class="docutils literal"><span class="pre">:</span></code>) with a semicolon
(<code class="docutils literal"><span class="pre">;</span></code>) and the underscore (<code class="docutils literal"><span class="pre">_</span></code>) with a hyphen (<code class="docutils literal"><span class="pre">-</span></code>).
Make sure to specify <code class="docutils literal"><span class="pre">http:</span></code> and not <code class="docutils literal"><span class="pre">http;</span></code>.
Make sure to specify <code class="docutils literal"><span class="pre">authorized_keys</span></code> and not <code class="docutils literal"><span class="pre">authorized-keys</span></code>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The previous script only gets the ssh public key from the
metadata server. It does not get user data, which is optional
data that can be passed by the user when requesting a new instance.
User data is often used to run a custom script when an instance boots.</p>
<p class="last">As the OpenStack metadata service is compatible with version
2009-04-04 of the Amazon EC2 metadata service, consult the
Amazon EC2 documentation on <a class="reference external" href="http://docs.amazonwebservices.com/AWSEC2/2009-04-04/UserGuide/AESDG-chapter-instancedata.html">Using Instance Metadata</a> for details on how to get user data.</p>
</div>
</div>
<div class="section" id="disable-the-zeroconf-route">
<h2>Disable the zeroconf route<a class="headerlink" href="#disable-the-zeroconf-route" title="Permalink to this headline">¶</a></h2>
<p>For the instance to access the metadata service,
you must disable the default zeroconf route:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> <span class="nb">echo</span> <span class="s2">&quot;NOZEROCONF=yes&quot;</span> &gt;&gt; /etc/sysconfig/network
</pre></div>
</div>
</div>
<div class="section" id="configure-console">
<h2>Configure console<a class="headerlink" href="#configure-console" title="Permalink to this headline">¶</a></h2>
<p>For the <strong class="command">nova console-log</strong> command to work properly
on CentOS 7.``x``, you might need to do the following steps:</p>
<ol class="arabic">
<li><p class="first">Edit the <code class="docutils literal"><span class="pre">/etc/default/grub</span></code> file and configure the
<code class="docutils literal"><span class="pre">GRUB_CMDLINE_LINUX</span></code> option. Delete the <code class="docutils literal"><span class="pre">rhgb</span> <span class="pre">quiet</span></code>
and add the <code class="docutils literal"><span class="pre">console=tty0</span> <span class="pre">console=ttyS0,115200n8</span></code> to the option:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span>...
GRUB_CMDLINE_LINUX=&quot;crashkernel=auto console=tty0 console=ttyS0,115200n8&quot;
</pre></div>
</div>
</li>
<li><p class="first">Run the following command to save the changes:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> grub2-mkconfig -o /boot/grub2/grub.cfg
<span class="go">Generating grub configuration file ...</span>
<span class="go">Found linux image: /boot/vmlinuz-3.10.0-229.14.1.el7.x86_64</span>
<span class="go">Found initrd image: /boot/initramfs-3.10.0-229.14.1.el7.x86_64.img</span>
<span class="go">Found linux image: /boot/vmlinuz-3.10.0-229.4.2.el7.x86_64</span>
<span class="go">Found initrd image: /boot/initramfs-3.10.0-229.4.2.el7.x86_64.img</span>
<span class="go">Found linux image: /boot/vmlinuz-3.10.0-229.el7.x86_64</span>
<span class="go">Found initrd image: /boot/initramfs-3.10.0-229.el7.x86_64.img</span>
<span class="go">Found linux image: /boot/vmlinuz-0-rescue-605f01abef434fb98dd1309e774b72ba</span>
<span class="go">Found initrd image: /boot/initramfs-0-rescue-605f01abef434fb98dd1309e774b72ba.img</span>
<span class="go">done</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="shut-down-the-instance">
<h2>Shut down the instance<a class="headerlink" href="#shut-down-the-instance" title="Permalink to this headline">¶</a></h2>
<p>From inside the instance, as root:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> /sbin/shutdown -h now
</pre></div>
</div>
</div>
<div class="section" id="clean-up-remove-mac-address-details">
<h2>Clean up (remove MAC address details)<a class="headerlink" href="#clean-up-remove-mac-address-details" title="Permalink to this headline">¶</a></h2>
<p>The operating system records the MAC address of the virtual Ethernet
card in locations such as <code class="docutils literal"><span class="pre">/etc/sysconfig/network-scripts/ifcfg-eth0</span></code>
and <code class="docutils literal"><span class="pre">/etc/udev/rules.d/70-persistent-net.rules</span></code> during the instance
process. However, each time the image boots up, the virtual Ethernet
card will have a different MAC address, so this information must
be deleted from the configuration file.</p>
<p>There is a utility called <strong class="command">virt-sysprep</strong>, that performs
various cleanup tasks such as removing the MAC address references.
It will clean up a virtual machine image in place:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> virt-sysprep -d centos
</pre></div>
</div>
</div>
<div class="section" id="undefine-the-libvirt-domain">
<h2>Undefine the libvirt domain<a class="headerlink" href="#undefine-the-libvirt-domain" title="Permalink to this headline">¶</a></h2>
<p>Now that you can upload the image to the Image service, you no
longer need to have this virtual machine image managed by libvirt.
Use the <strong class="command">virsh undefine vm-image</strong> command to inform libvirt:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> virsh undefine centos
</pre></div>
</div>
</div>
<div class="section" id="image-is-complete">
<h2>Image is complete<a class="headerlink" href="#image-is-complete" title="Permalink to this headline">¶</a></h2>
<p>The underlying image file that you created with the
<strong class="command">qemu-img create</strong> command is ready to be uploaded.
For example, you can upload the <code class="docutils literal"><span class="pre">/tmp/centos.qcow2</span></code>
image to the Image service by using the <strong class="command">openstack image create</strong>
command. For more information, see the
<a class="reference external" href="http://docs.openstack.org/user-guide/common/cli-manage-images.html#create-or-update-an-image-glance">Create or update an image</a>.</p>
</div>
</div>


              </div>
            </div>
          </div>
          <div class="docs-actions">
          
            <a href="virt-install.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Use virt-install and connect by using a local VNC client"></i></a>
          
          
            <a href="ubuntu-image.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Example: Ubuntu image"></i></a>
          
            <a id="logABugLink3" href="#" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
          </div>
          <div class="row docs-byline bottom">
            <div class="docs-updated">updated: 2016-12-30 18:30</div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8 docs-license">
<a href="https://creativecommons.org/licenses/by/3.0/">
 <img src="_static/images/docs/license.png" alt="Creative Commons Attribution 3.0 License"/>
</a>
<p>
 Except where otherwise noted, this document is licensed under
 <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons
 Attribution 3.0 License</a>. See all <a href="http://www.openstack.org/legal">
 OpenStack Legal Documents</a>.
</p>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 docs-actions-wrapper">
            <!-- ID buglinkbottom added so that pre-filled doc bugs
                 are sent to Launchpad projects related to the document -->
              <a href="#" id="logABugLink2" class="docs-footer-actions"><i class="fa fa-bug"></i> found an error? report a bug</a>
              <a href="http://ask.openstack.org/" class="docs-footer-actions"><i class="fa fa-question-circle"></i> questions?</a>
            </div>
          </div>
        </div>
<div class="col-lg-3 col-md-4 col-sm-4 col-lg-pull-9 col-md-pull-8 col-sm-pull-8 docs-sidebar">
  <div class="search-icon show">
    <i class="fa fa-search"></i> Search
  </div>
  <div class="btn-group docs-sidebar-releases">
    <button onclick="location.href='http://docs.openstack.org/'" class="btn docs-sidebar-home" data-toggle="tooltip" data-placement="top" title="Docs Home"><i class="fa fa-arrow-circle-o-left"></i></button>
<button href="#" type="button" data-toggle="dropdown" class="btn docs-sidebar-release-select">OpenStack Documentation<i class="fa fa-caret-down"></i></button>
    <ul class="dropdown-menu docs-sidebar-dropdown" role="menu" aria-labelledby="dLabel">
      <li role="presentation" class="dropdown-header">Guides</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#install-guides">Install Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#user-guides">User Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#configuration-guides">Configuration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#ops-and-admin-guides">Operations and Administration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#api-guides">API Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#contributor-guides">Contributor Guides</a></li>
      <li role="presentation" class="dropdown-header">Languages</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ja/">日本語 (Japanese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/de/">Deutsch (German)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/fr/">Français (French)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/pt_BR/">Português (Portuguese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/zh_CN/">简体中文 (Simplified Chinese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ko_KR/">한국어 (Korean)</a></li>
    </ul>
  </div>
  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="table-of-contents">
      <a href="index-2.html" class="docs-sidebar-section-title"><h4>Contents</h4></a>
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="common/conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="obtain-images.html">Get images</a></li>
<li class="toctree-l1"><a class="reference internal" href="openstack-images.html">Image requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="modify-images.html">Modify images</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="create-images-manually.html">Create images manually</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="net-running.html">Verify the libvirt default network is running</a></li>
<li class="toctree-l2"><a class="reference internal" href="virt-manager.html">Use the virt-manager X11 GUI</a></li>
<li class="toctree-l2"><a class="reference internal" href="virt-install.html">Use virt-install and connect by using a local VNC client</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Example: CentOS image</a></li>
<li class="toctree-l2"><a class="reference internal" href="ubuntu-image.html">Example: Ubuntu image</a></li>
<li class="toctree-l2"><a class="reference internal" href="fedora-image.html">Example: Fedora image</a></li>
<li class="toctree-l2"><a class="reference internal" href="windows-image.html">Example: Microsoft Windows image</a></li>
<li class="toctree-l2"><a class="reference internal" href="freebsd-image.html">Example: FreeBSD image</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="create-images-automatically.html">Tool support for image creation</a></li>
<li class="toctree-l1"><a class="reference internal" href="convert-images.html">Converting between image formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="share-images.html">Image sharing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="common/app-support.html">Community support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="common/glossary.html">Glossary</a></li>
</ul>

    </div>
  </div>
</div>
      </div>
    </div>
<footer>
  <div class="container">
    <div class="row footer-links">
      <div class="col-lg-2 col-sm-2">
        <h3>OpenStack</h3>
        <ul>
          <li><a href="http://openstack.org/projects/">Projects</a></li>
          <li><a href="http://openstack.org/projects/openstack-security/">OpenStack Security</a></li>
          <li><a href="http://openstack.org/projects/openstack-faq/">Common Questions</a></li>
          <li><a href="http://openstack.org/blog/">Blog</a></li>
          <li><a href="http://openstack.org/news/">News</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Community</h3>
        <ul>
          <li><a href="http://openstack.org/community/">User Groups</a></li>
          <li><a href="http://openstack.org/community/events/">Events</a></li>
          <li><a href="http://openstack.org/community/jobs/">Jobs</a></li>
          <li><a href="http://openstack.org/foundation/companies/">Companies</a></li>
          <li><a href="http://docs.openstack.org/infra/manual/developers.html">Contribute</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Documentation</h3>
        <ul>
          <li><a href="http://docs.openstack.org/">OpenStack Manuals</a></li>
          <li><a href="http://openstack.org/software/start/">Getting Started</a></li>
          <li><a href="http://developer.openstack.org/">API Documentation</a></li>
          <li><a href="https://wiki.openstack.org/">Wiki</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Branding & Legal</h3>
        <ul>
          <li><a href="http://openstack.org/brand/">Logos & Guidelines</a></li>
          <li><a href="http://openstack.org/brand/openstack-trademark-policy/">Trademark Policy</a></li>
          <li><a href="http://openstack.org/privacy/">Privacy Policy</a></li>
          <li><a href="https://wiki.openstack.org/wiki/How_To_Contribute#Contributor_License_Agreement">OpenStack CLA</a></li>
        </ul>
      </div>
      <div class="col-lg-4 col-sm-4">
        <h3>Stay In Touch</h3>
        <a href="https://twitter.com/OpenStack" target="_blank" class="social-icons footer-twitter"></a>
        <a href="https://www.facebook.com/openstack" target="_blank" class="social-icons footer-facebook"></a>
        <a href="https://www.linkedin.com/company/openstack" target="_blank" class="social-icons footer-linkedin"></a>
        <a href="https://www.youtube.com/user/OpenStackFoundation" target="_blank" class="social-icons footer-youtube"></a>
        <p class="fine-print">
          The OpenStack project is provided under the
          <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>. Openstack.org is powered by
          <a href="http://rackspace.com/" target="_blank">Rackspace Cloud Computing</a>.
        </p>
      </div>
    </div>
  </div>
</footer>
<!-- jQuery -->
<script type="text/javascript" src="_static/js/jquery-1.11.3.js"></script>

<!-- Bootstrap JavaScript -->
<script type="text/javascript" src="_static/js/bootstrap.min.js"></script>

<!-- The rest of the JS -->
<script type="text/javascript" src="_static/js/navigation.js"></script>

<!-- Docs JS -->
<script type="text/javascript" src="_static/js/docs.js"></script>

<!-- Popovers -->
<script type="text/javascript" src="_static/js/webui-popover.js"></script>

<!-- Javascript for page -->
<script language="JavaScript">
/* build a description of this page including SHA, source location on git repo,
   build time and the project's launchpad bug tag. Set the HREF of the bug
   buttons */

    var lineFeed = "%0A";
    var gitURL = "Source: Can't derive source file URL";

    /* there have been cases where "pagename" wasn't set; better check for it */
        /* The URL of the source file on Git is based on the giturl variable
           in conf.py, which must be manually initialized to the source file
           URL in Git.
           "pagename" is a standard sphinx parameter containing the name of
           the source file, without extension.                             */

        var sourceFile = "centos-image" + ".rst";
        gitURL = "Source: http://git.openstack.org/cgit/openstack/openstack-manuals/tree/doc/image-guide/source" + "/" + sourceFile;

    /* gitsha, project and bug_tag rely on variables in conf.py */
    var gitSha = "SHA: 522e4919f8db2885f022e41fa599c8c3056b8485";
        var bugProject = "openstack-manuals";
        var bugTitle = "Example: CentOS image in Virtual Machine Image Guide";
    var fieldTags = "image-guide";

    /* "last_updated" is the build date and time. It relies on the
       conf.py variable "html_last_updated_fmt", which should include
       year/month/day as well as hours and minutes                   */
    var buildstring = "Release: 0.9 on 2016-12-30 18:30";

    var fieldComment = encodeURI(buildstring) +
                       lineFeed + encodeURI(gitSha) +
                       lineFeed + encodeURI(gitURL) ;

    logABug(bugTitle, bugProject, fieldComment, fieldTags);
</script>

<!-- Javascript for search boxes (both sidebar and top nav) -->
<script type="text/javascript">
(function() {
var cx = '000108871792296872333:noj9nikm74i';
var gcse = document.createElement('script');
gcse.type = 'text/javascript';
gcse.async = true;
gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
'//www.google.com/cse/cse.js?cx=' + cx;
var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(gcse, s);
})();
</script>

  </body>

<!-- Mirrored from docs.openstack.org/image-guide/centos-image.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Jan 2017 11:17:00 GMT -->
</html>