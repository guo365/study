<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from docs.openstack.org/ops-guide/ops-network-troubleshooting.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Jan 2017 09:36:50 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>

    <title>OpenStack Docs: Network Troubleshooting</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link href="_static/css/bootstrap.min.css" rel="stylesheet">

<!-- Pygments CSS -->
<link href="_static/css/native.css" rel="stylesheet">

<!-- Fonts -->
<link href="../../maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>

<!-- Custom CSS -->
<link href="_static/css/combined.css" rel="stylesheet">
<link href="_static/css/styles.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
  


<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','../../www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17511903-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

  </head>
  <body>
<nav class="navbar navbar-default inner" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="brand-wrapper">
        <a class="navbar-brand" href="http://docs.openstack.org/"></a>
      </div>
      <div class="search-icon show"><i class="fa fa-search"></i> Search</div></div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <div class="search-container tiny">
        <div id="gcse">
          <script type="text/javascript">
(function() {
  var cx = '000108871792296872333:noj9nikm74i';
  var gcse = document.createElement('script');
  gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//www.google.com/cse/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();
          </script>
          <gcse:search gname="standard"></gcse:search>
        </div>
        <i class="fa fa-times close-search"></i>
      </div>
      <ul class="nav navbar-nav navbar-main show">
        <li>
          <div id="gcse-mobile">
            <gcse:search gname="mobile"></gcse:search>
          </div>
        </li>
        <li>
          <a href="http://www.openstack.org/software/" class="drop" id="dropdownMenuSoftware">Software <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuSoftware">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/project-navigator/">Project Navigator</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sample-configs/">Sample Configs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/start/">Get Started</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/roadmap/">Roadmap</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/latest-release/">Latest Release</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sourcecode/">Source Code</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/user-stories/" class="drop" id="dropdownMenuUsers">Users <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuUsers">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/user-stories/">Overview</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/enterprise/">OpenStack in the Enterprise</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/appdev/">Application Developers</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org/">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/surveys/landing">User Survey</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/community/" class="drop" id="dropdownMenuCommunity">Community <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuCommunity">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/">Welcome! Start Here</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/">OpenStack Foundation</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://wiki.openstack.org/">OpenStack Wiki</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://groups.openstack.org/">User Groups</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/speakers/">Speakers Bureau</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/companies/">Supporting Companies</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/jobs/">Jobs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/join/">Join The Community</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/marketplace/">Marketplace</a>
        </li>
        <li>
          <a href="http://www.openstack.org/events/" class="drop" id="dropdownMenuEvents">Events <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/events/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/summit/">The OpenStack Summit</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/events/">More OpenStack Events</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/events/#openstack_days">OpenStack Days</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/learn/" class="drop" id="dropdownMenuLearn">Learn <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/marketplace/training/">Training</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org/">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://ask.openstack.org/">Ask a Technical Question</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/news/">News</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/blog/">Blog</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/videos/summits">Summit Videos</a></li>
          </ul>
        </li>
        <li>
          <a href="http://docs.openstack.org/">Docs</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
    <div class="container docs-book-wrapper">
      <div class="row">
        <div class="col-lg-9 col-md-8 col-sm-8 col-lg-push-3 col-md-push-4 col-sm-push-4">
<div class="row">
  <div class="col-lg-8">
    <h2>Network Troubleshooting</h2>
  </div>
  <div class="docs-actions">
    
    <a href="ops-uninstall.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Uninstalling"></i></a>
    
    
    <a href="ops-logging-monitoring.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Logging and Monitoring"></i></a>
    
    <a id="logABugLink1" href="#" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
  </div>
</div>
          <div class="row docs-byline">
            <div class="docs-updated">updated: 2016-12-30 18:30</div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="docs-top-contents">

<h5><a href="index-2.html">Contents</a></h5>
<ul>
<li><a class="reference internal" href="#">Network Troubleshooting</a><ul>
<li><a class="reference internal" href="#using-ip-a-to-check-interface-states">Using &#8220;ip a&#8221; to Check Interface States</a></li>
<li><a class="reference internal" href="#visualizing-nova-network-traffic-in-the-cloud">Visualizing nova-network Traffic in the Cloud</a></li>
<li><a class="reference internal" href="#visualizing-openstack-networking-service-traffic-in-the-cloud">Visualizing OpenStack Networking Service Traffic in the Cloud</a></li>
<li><a class="reference internal" href="#finding-a-failure-in-the-path">Finding a Failure in the Path</a></li>
<li><a class="reference internal" href="#tcpdump">tcpdump</a></li>
<li><a class="reference internal" href="#iptables">iptables</a></li>
<li><a class="reference internal" href="#network-configuration-in-the-database-for-nova-network">Network Configuration in the Database for nova-network</a><ul>
<li><a class="reference internal" href="#manually-disassociating-a-floating-ip">Manually Disassociating a Floating IP</a></li>
</ul>
</li>
<li><a class="reference internal" href="#debugging-dhcp-issues-with-nova-network">Debugging DHCP Issues with nova-network</a></li>
<li><a class="reference internal" href="#debugging-dns-issues">Debugging DNS Issues</a></li>
<li><a class="reference internal" href="#troubleshooting-open-vswitch">Troubleshooting Open vSwitch</a></li>
<li><a class="reference internal" href="#dealing-with-network-namespaces">Dealing with Network Namespaces</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

              </div>
              <div class="docs-body">

  <div class="section" id="network-troubleshooting">
<h1>Network Troubleshooting<a class="headerlink" href="#network-troubleshooting" title="Permalink to this headline">¶</a></h1>
<p>Network troubleshooting can be challenging. A network issue may cause
problems at any point in the cloud. Using a logical troubleshooting
procedure can help mitigate the issue and isolate where the network issue is.
This chapter aims to give you the information you need to identify any
issues for <code class="docutils literal"><span class="pre">nova-network</span></code> or OpenStack Networking (neutron) with Linux
Bridge or Open vSwitch.</p>
<div class="section" id="using-ip-a-to-check-interface-states">
<h2>Using &#8220;ip a&#8221; to Check Interface States<a class="headerlink" href="#using-ip-a-to-check-interface-states" title="Permalink to this headline">¶</a></h2>
<p>On compute nodes and nodes running <code class="docutils literal"><span class="pre">nova-network</span></code>, use the following
command to see information about interfaces, including information about
IPs, VLANs, and whether your interfaces are up:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ip a
</pre></div>
</div>
<p>If you are encountering any sort of networking difficulty, one good initial
troubleshooting step is to make sure that your interfaces are up. For example:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ip a <span class="p">|</span> grep state
<span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN</span>
<span class="go">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP</span>
<span class="go">   qlen 1000</span>
<span class="go">3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast</span>
<span class="go">   master br100 state UP qlen 1000</span>
<span class="go">4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span>
<span class="go">5: br100: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP</span>
</pre></div>
</div>
<p>You can safely ignore the state of <code class="docutils literal"><span class="pre">virbr0</span></code>, which is a default bridge
created by libvirt and not used by OpenStack.</p>
</div>
<div class="section" id="visualizing-nova-network-traffic-in-the-cloud">
<h2>Visualizing nova-network Traffic in the Cloud<a class="headerlink" href="#visualizing-nova-network-traffic-in-the-cloud" title="Permalink to this headline">¶</a></h2>
<p>If you are logged in to an instance and ping an external host, for
example, Google, the ping packet takes the route shown in
<a class="reference internal" href="#figure-traffic-route"><span>Figure. Traffic route for ping packet</span></a>.</p>
<div class="figure" id="id2">
<span id="figure-traffic-route"></span><a class="reference internal image-reference" href="_images/osog_1201.png"><img alt="Traffic route for ping packet" src="_images/osog_1201.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text">Figure. Traffic route for ping packet</span></p>
</div>
<ol class="arabic">
<li><p class="first">The instance generates a packet and places it on the virtual Network
Interface Card (NIC) inside the instance, such as <code class="docutils literal"><span class="pre">eth0</span></code>.</p>
</li>
<li><p class="first">The packet transfers to the virtual NIC of the compute host, such as,
<code class="docutils literal"><span class="pre">vnet1</span></code>. You can find out what vnet NIC is being used by looking at
the <code class="docutils literal"><span class="pre">/etc/libvirt/qemu/instance-xxxxxxxx.xml</span></code> file.</p>
</li>
<li><p class="first">From the vnet NIC, the packet transfers to a bridge on the compute
node, such as <code class="docutils literal"><span class="pre">br100</span></code>.</p>
<p>If you run FlatDHCPManager, one bridge is on the compute node. If you
run VlanManager, one bridge exists for each VLAN.</p>
<p>To see which bridge the packet will use, run the command:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> brctl show
</pre></div>
</div>
<p>Look for the vnet NIC. You can also reference <code class="docutils literal"><span class="pre">nova.conf</span></code> and look
for the <code class="docutils literal"><span class="pre">flat_interface_bridge</span></code> option.</p>
</li>
<li><p class="first">The packet transfers to the main NIC of the compute node. You can
also see this NIC in the <strong class="command">brctl</strong> output, or you can find it by
referencing the <code class="docutils literal"><span class="pre">flat_interface</span></code> option in <code class="docutils literal"><span class="pre">nova.conf</span></code>.</p>
</li>
<li><p class="first">After the packet is on this NIC, it transfers to the compute node&#8217;s
default gateway. The packet is now most likely out of your control at
this point. The diagram depicts an external gateway. However, in the
default configuration with multi-host, the compute host is the
gateway.</p>
</li>
</ol>
<p>Reverse the direction to see the path of a ping reply. From this path,
you can see that a single packet travels across four different NICs. If
a problem occurs with any of these NICs, a network issue occurs.</p>
</div>
<div class="section" id="visualizing-openstack-networking-service-traffic-in-the-cloud">
<h2>Visualizing OpenStack Networking Service Traffic in the Cloud<a class="headerlink" href="#visualizing-openstack-networking-service-traffic-in-the-cloud" title="Permalink to this headline">¶</a></h2>
<p>OpenStack Networking has many more degrees of freedom than
<code class="docutils literal"><span class="pre">nova-network</span></code> does because of its pluggable back end. It can be
configured with open source or vendor proprietary plug-ins that control
software defined networking (SDN) hardware or plug-ins that use Linux
native facilities on your hosts, such as Open vSwitch or Linux Bridge.</p>
<p>The networking chapter of the <a class="reference external" href="http://docs.openstack.org/admin-guide/networking.html">OpenStack Administrator
Guide</a>
shows a variety of networking scenarios and their connection paths. The
purpose of this section is to give you the tools to troubleshoot the
various components involved however they are plumbed together in your
environment.</p>
<p>For this example, we will use the Open vSwitch (OVS) back end. Other
back-end plug-ins will have very different flow paths. OVS is the most
popularly deployed network driver, according to the April 2016
OpenStack User Survey. We&#8217;ll describe each step in turn, with
<a class="reference internal" href="#network-paths"><span>Figure. Neutron network paths</span></a> for reference.</p>
<ol class="arabic">
<li><p class="first">The instance generates a packet and places it on the virtual NIC
inside the instance, such as eth0.</p>
</li>
<li><p class="first">The packet transfers to a Test Access Point (TAP) device on the
compute host, such as tap690466bc-92. You can find out what TAP is
being used by looking at the
<code class="docutils literal"><span class="pre">/etc/libvirt/qemu/instance-xxxxxxxx.xml</span></code> file.</p>
<p>The TAP device name is constructed using the first 11 characters of
the port ID (10 hex digits plus an included &#8216;-&#8216;), so another means of
finding the device name is to use the <strong class="command">neutron</strong> command. This
returns a pipe-delimited list, the first item of which is the port
ID. For example, to get the port ID associated with IP address
10.0.0.10, do this:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> neutron port-list <span class="p">|</span> grep 10.0.0.10 <span class="p">|</span> cut -d <span class="se">\|</span> -f 2
<span class="go"> ff387e54-9e54-442b-94a3-aa4481764f1d</span>
</pre></div>
</div>
<p>Taking the first 11 characters, we can construct a device name of
tapff387e54-9e from this output.</p>
<div class="figure" id="id3">
<span id="network-paths"></span><a class="reference internal image-reference" href="_images/osog_1202.png"><img alt="Neutron network paths" src="_images/osog_1202.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-text">Figure. Neutron network paths</span></p>
</div>
</li>
<li><p class="first">The TAP device is connected to the integration bridge, <code class="docutils literal"><span class="pre">br-int</span></code>.
This bridge connects all the instance TAP devices and any other
bridges on the system. In this example, we have <code class="docutils literal"><span class="pre">int-br-eth1</span></code> and
<code class="docutils literal"><span class="pre">patch-tun</span></code>. <code class="docutils literal"><span class="pre">int-br-eth1</span></code> is one half of a veth pair connecting
to the bridge <code class="docutils literal"><span class="pre">br-eth1</span></code>, which handles VLAN networks trunked over
the physical Ethernet device <code class="docutils literal"><span class="pre">eth1</span></code>. <code class="docutils literal"><span class="pre">patch-tun</span></code> is an Open
vSwitch internal port that connects to the <code class="docutils literal"><span class="pre">br-tun</span></code> bridge for GRE
networks.</p>
<p>The TAP devices and veth devices are normal Linux network devices and
may be inspected with the usual tools, such as <strong class="command">ip</strong> and
<strong class="command">tcpdump</strong>. Open vSwitch internal devices, such as <code class="docutils literal"><span class="pre">patch-tun</span></code>,
are only visible within the Open vSwitch environment. If you try to
run <strong class="command">tcpdump -i patch-tun</strong>, it will raise an error, saying that
the device does not exist.</p>
<p>It is possible to watch packets on internal interfaces, but it does
take a little bit of networking gymnastics. First you need to create
a dummy network device that normal Linux tools can see. Then you need
to add it to the bridge containing the internal interface you want to
snoop on. Finally, you need to tell Open vSwitch to mirror all
traffic to or from the internal port onto this dummy port. After all
this, you can then run <strong class="command">tcpdump</strong> on the dummy interface and see
the traffic on the internal port.</p>
<p><strong>To capture packets from the patch-tun internal interface on integration
bridge, br-int:</strong></p>
<ol class="arabic">
<li><p class="first">Create and bring up a dummy interface, <code class="docutils literal"><span class="pre">snooper0</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ip link add name snooper0 <span class="nb">type</span> dummy
<span class="gp">#</span> ip link <span class="nb">set</span> dev snooper0 up
</pre></div>
</div>
</li>
<li><p class="first">Add device <code class="docutils literal"><span class="pre">snooper0</span></code> to bridge <code class="docutils literal"><span class="pre">br-int</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-vsctl add-port br-int snooper0
</pre></div>
</div>
</li>
<li><p class="first">Create mirror of <code class="docutils literal"><span class="pre">patch-tun</span></code> to <code class="docutils literal"><span class="pre">snooper0</span></code> (returns UUID of
mirror port):</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-vsctl -- <span class="nb">set</span> Bridge br-int <span class="nv">mirrors</span><span class="o">=</span>@m  -- --id<span class="o">=</span>@snooper0 <span class="se">\</span>
<span class="go">  get Port snooper0  -- --id=@patch-tun get Port patch-tun \</span>
<span class="go">  -- --id=@m create Mirror name=mymirror select-dst-port=@patch-tun \</span>
<span class="go">  select-src-port=@patch-tun output-port=@snooper0 select_all=1</span>
</pre></div>
</div>
</li>
<li><p class="first">Profit. You can now see traffic on <code class="docutils literal"><span class="pre">patch-tun</span></code> by running
<strong class="command">tcpdump -i snooper0</strong>.</p>
</li>
<li><p class="first">Clean up by clearing all mirrors on <code class="docutils literal"><span class="pre">br-int</span></code> and deleting the dummy
interface:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-vsctl clear Bridge br-int mirrors
<span class="gp">#</span> ovs-vsctl del-port br-int snooper0
<span class="gp">#</span> ip link delete dev snooper0
</pre></div>
</div>
</li>
</ol>
<p>On the integration bridge, networks are distinguished using internal
VLANs regardless of how the networking service defines them. This
allows instances on the same host to communicate directly without
transiting the rest of the virtual, or physical, network. These
internal VLAN IDs are based on the order they are created on the node
and may vary between nodes. These IDs are in no way related to the
segmentation IDs used in the network definition and on the physical
wire.</p>
<p>VLAN tags are translated between the external tag defined in the
network settings, and internal tags in several places. On the
<code class="docutils literal"><span class="pre">br-int</span></code>, incoming packets from the <code class="docutils literal"><span class="pre">int-br-eth1</span></code> are translated
from external tags to internal tags. Other translations also happen
on the other bridges and will be discussed in those sections.</p>
<p><strong>To discover which internal VLAN tag is in use for a given external VLAN
by using the ovs-ofctl command</strong></p>
<ol class="arabic">
<li><p class="first">Find the external VLAN tag of the network you&#8217;re interested in. This
is the <code class="docutils literal"><span class="pre">provider:segmentation_id</span></code> as returned by the networking
service:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> neutron net-show --fields provider:segmentation_id &lt;network name&gt;
<span class="go">+---------------------------+--------------------------------------+</span>
<span class="go">| Field                     | Value                                |</span>
<span class="go">+---------------------------+--------------------------------------+</span>
<span class="go">| provider:network_type     | vlan                                 |</span>
<span class="go">| provider:segmentation_id  | 2113                                 |</span>
<span class="go">+---------------------------+--------------------------------------+</span>
</pre></div>
</div>
</li>
<li><p class="first">Grep for the <code class="docutils literal"><span class="pre">provider:segmentation_id</span></code>, 2113 in this case, in the
output of <strong class="command">ovs-ofctl dump-flows br-int</strong>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-ofctl dump-flows br-int <span class="p">|</span> grep <span class="nv">vlan</span><span class="o">=</span>2113
<span class="go">cookie=0x0, duration=173615.481s, table=0, n_packets=7676140,</span>
<span class="go">n_bytes=444818637, idle_age=0, hard_age=65534, priority=3,</span>
<span class="go">in_port=1,dl_vlan=2113 actions=mod_vlan_vid:7,NORMAL</span>
</pre></div>
</div>
<p>Here you can see packets received on port ID 1 with the VLAN tag 2113
are modified to have the internal VLAN tag 7. Digging a little
deeper, you can confirm that port 1 is in fact <code class="docutils literal"><span class="pre">int-br-eth1</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-ofctl show br-int
<span class="go">OFPT_FEATURES_REPLY (xid=0x2): dpid:000022bc45e1914b</span>
<span class="go">n_tables:254, n_buffers:256</span>
<span class="go">capabilities: FLOW_STATS TABLE_STATS PORT_STATS QUEUE_STATS</span>
<span class="go">ARP_MATCH_IP</span>
<span class="go">actions: OUTPUT SET_VLAN_VID SET_VLAN_PCP STRIP_VLAN SET_DL_SRC</span>
<span class="go">SET_DL_DST SET_NW_SRC SET_NW_DST SET_NW_TOS SET_TP_SRC</span>
<span class="go">SET_TP_DST ENQUEUE</span>
<span class="go"> 1(int-br-eth1): addr:c2:72:74:7f:86:08</span>
<span class="go">     config:     0</span>
<span class="go">     state:      0</span>
<span class="go">     current:    10GB-FD COPPER</span>
<span class="go">     speed: 10000 Mbps now, 0 Mbps max</span>
<span class="go"> 2(patch-tun): addr:fa:24:73:75:ad:cd</span>
<span class="go">     config:     0</span>
<span class="go">     state:      0</span>
<span class="go">     speed: 0 Mbps now, 0 Mbps max</span>
<span class="go"> 3(tap9be586e6-79): addr:fe:16:3e:e6:98:56</span>
<span class="go">     config:     0</span>
<span class="go">     state:      0</span>
<span class="go">     current:    10MB-FD COPPER</span>
<span class="go">     speed: 10 Mbps now, 0 Mbps max</span>
<span class="go"> LOCAL(br-int): addr:22:bc:45:e1:91:4b</span>
<span class="go">     config:     0</span>
<span class="go">     state:      0</span>
<span class="go">     speed: 0 Mbps now, 0 Mbps max</span>
<span class="go">OFPT_GET_CONFIG_REPLY (xid=0x4): frags=normal miss_send_len=0</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first">The next step depends on whether the virtual network is configured to
use 802.1q VLAN tags or GRE:</p>
<ol class="arabic">
<li><p class="first">VLAN-based networks exit the integration bridge via veth interface
<code class="docutils literal"><span class="pre">int-br-eth1</span></code> and arrive on the bridge <code class="docutils literal"><span class="pre">br-eth1</span></code> on the other
member of the veth pair <code class="docutils literal"><span class="pre">phy-br-eth1</span></code>. Packets on this interface
arrive with internal VLAN tags and are translated to external tags
in the reverse of the process described above:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-ofctl dump-flows br-eth1 <span class="p">|</span> grep 2113
<span class="go">cookie=0x0, duration=184168.225s, table=0, n_packets=0, n_bytes=0,</span>
<span class="go">idle_age=65534, hard_age=65534, priority=4,in_port=1,dl_vlan=7</span>
<span class="go">actions=mod_vlan_vid:2113,NORMAL</span>
</pre></div>
</div>
<p>Packets, now tagged with the external VLAN tag, then exit onto the
physical network via <code class="docutils literal"><span class="pre">eth1</span></code>. The Layer2 switch this interface is
connected to must be configured to accept traffic with the VLAN ID
used. The next hop for this packet must also be on the same
layer-2 network.</p>
</li>
<li><p class="first">GRE-based networks are passed with <code class="docutils literal"><span class="pre">patch-tun</span></code> to the tunnel
bridge <code class="docutils literal"><span class="pre">br-tun</span></code> on interface <code class="docutils literal"><span class="pre">patch-int</span></code>. This bridge also
contains one port for each GRE tunnel peer, so one for each
compute node and network node in your network. The ports are named
sequentially from <code class="docutils literal"><span class="pre">gre-1</span></code> onward.</p>
<p>Matching <code class="docutils literal"><span class="pre">gre-&lt;n&gt;</span></code> interfaces to tunnel endpoints is possible by
looking at the Open vSwitch state:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-vsctl show <span class="p">|</span> grep -A <span class="m">3</span> -e Port<span class="se">\ \&quot;</span>gre-
<span class="go">        Port &quot;gre-1&quot;</span>
<span class="go">            Interface &quot;gre-1&quot;</span>
<span class="go">                type: gre</span>
<span class="go">                options: {in_key=flow, local_ip=&quot;10.10.128.21&quot;,</span>
<span class="go">                out_key=flow, remote_ip=&quot;10.10.128.16&quot;}</span>
</pre></div>
</div>
<p>In this case, <code class="docutils literal"><span class="pre">gre-1</span></code> is a tunnel from IP 10.10.128.21, which
should match a local interface on this node, to IP 10.10.128.16 on
the remote side.</p>
<p>These tunnels use the regular routing tables on the host to route
the resulting GRE packet, so there is no requirement that GRE
endpoints are all on the same layer-2 network, unlike VLAN
encapsulation.</p>
<p>All interfaces on the <code class="docutils literal"><span class="pre">br-tun</span></code> are internal to Open vSwitch. To
monitor traffic on them, you need to set up a mirror port as
described above for <code class="docutils literal"><span class="pre">patch-tun</span></code> in the <code class="docutils literal"><span class="pre">br-int</span></code> bridge.</p>
<p>All translation of GRE tunnels to and from internal VLANs happens
on this bridge.</p>
</li>
</ol>
<p><strong>To discover which internal VLAN tag is in use for a GRE tunnel by using
the ovs-ofctl command</strong></p>
<ol class="arabic">
<li><p class="first">Find the <code class="docutils literal"><span class="pre">provider:segmentation_id</span></code> of the network you&#8217;re
interested in. This is the same field used for the VLAN ID in
VLAN-based networks:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> neutron net-show --fields provider:segmentation_id &lt;network name&gt;
<span class="go">+--------------------------+-------+</span>
<span class="go">| Field                    | Value |</span>
<span class="go">+--------------------------+-------+</span>
<span class="go">| provider:network_type    | gre   |</span>
<span class="go">| provider:segmentation_id | 3     |</span>
<span class="go">+--------------------------+-------+</span>
</pre></div>
</div>
</li>
<li><p class="first">Grep for 0x&lt;<code class="docutils literal"><span class="pre">provider:segmentation_id</span></code>&gt;, 0x3 in this case, in the
output of <code class="docutils literal"><span class="pre">ovs-ofctl</span> <span class="pre">dump-flows</span> <span class="pre">br-tun</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-ofctl dump-flows br-tun<span class="p">|</span>grep 0x3
<span class="go">cookie=0x0, duration=380575.724s, table=2, n_packets=1800,</span>
<span class="go">n_bytes=286104, priority=1,tun_id=0x3</span>
<span class="go">actions=mod_vlan_vid:1,resubmit(,10)</span>
<span class="go"> cookie=0x0, duration=715.529s, table=20, n_packets=5,</span>
<span class="go">n_bytes=830, hard_timeout=300,priority=1,</span>
<span class="go">vlan_tci=0x0001/0x0fff,dl_dst=fa:16:3e:a6:48:24</span>
<span class="go">actions=load:0-&gt;NXM_OF_VLAN_TCI[],</span>
<span class="go">load:0x3-&gt;NXM_NX_TUN_ID[],output:53</span>
<span class="go"> cookie=0x0, duration=193729.242s, table=21, n_packets=58761,</span>
<span class="go">n_bytes=2618498, dl_vlan=1 actions=strip_vlan,set_tunnel:0x3,</span>
<span class="go">output:4,output:58,output:56,output:11,output:12,output:47,</span>
<span class="go">output:13,output:48,output:49,output:44,output:43,output:45,</span>
<span class="go">output:46,output:30,output:31,output:29,output:28,output:26,</span>
<span class="go">output:27,output:24,output:25,output:32,output:19,output:21,</span>
<span class="go">output:59,output:60,output:57,output:6,output:5,output:20,</span>
<span class="go">output:18,output:17,output:16,output:15,output:14,output:7,</span>
<span class="go">output:9,output:8,output:53,output:10,output:3,output:2,</span>
<span class="go">output:38,output:37,output:39,output:40,output:34,output:23,</span>
<span class="go">output:36,output:35,output:22,output:42,output:41,output:54,</span>
<span class="go">output:52,output:51,output:50,output:55,output:33</span>
</pre></div>
</div>
<p>Here, you see three flows related to this GRE tunnel. The first is
the translation from inbound packets with this tunnel ID to internal
VLAN ID 1. The second shows a unicast flow to output port 53 for
packets destined for MAC address fa:16:3e:a6:48:24. The third shows
the translation from the internal VLAN representation to the GRE
tunnel ID flooded to all output ports. For further details of the
flow descriptions, see the man page for <code class="docutils literal"><span class="pre">ovs-ofctl</span></code>. As in the
previous VLAN example, numeric port IDs can be matched with their
named representations by examining the output of <code class="docutils literal"><span class="pre">ovs-ofctl</span> <span class="pre">show</span> <span class="pre">br-tun</span></code>.</p>
</li>
</ol>
</li>
<li><p class="first">The packet is then received on the network node. Note that any
traffic to the l3-agent or dhcp-agent will be visible only within
their network namespace. Watching any interfaces outside those
namespaces, even those that carry the network traffic, will only show
broadcast packets like Address Resolution Protocols (ARPs), but
unicast traffic to the router or DHCP address will not be seen. See
<a class="reference internal" href="#dealing-with-network-namespaces"><span>Dealing with Network Namespaces</span></a>
for detail on how to run commands within these namespaces.</p>
<p>Alternatively, it is possible to configure VLAN-based networks to use
external routers rather than the l3-agent shown here, so long as the
external router is on the same VLAN:</p>
<ol class="arabic simple">
<li>VLAN-based networks are received as tagged packets on a physical
network interface, <code class="docutils literal"><span class="pre">eth1</span></code> in this example. Just as on the
compute node, this interface is a member of the <code class="docutils literal"><span class="pre">br-eth1</span></code>
bridge.</li>
<li>GRE-based networks will be passed to the tunnel bridge <code class="docutils literal"><span class="pre">br-tun</span></code>,
which behaves just like the GRE interfaces on the compute node.</li>
</ol>
</li>
<li><p class="first">Next, the packets from either input go through the integration
bridge, again just as on the compute node.</p>
</li>
<li><p class="first">The packet then makes it to the l3-agent. This is actually another
TAP device within the router&#8217;s network namespace. Router namespaces
are named in the form <code class="docutils literal"><span class="pre">qrouter-&lt;router-uuid&gt;</span></code>. Running <strong class="command">ip a</strong>
within the namespace will show the TAP device name,
qr-e6256f7d-31 in this example:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ip netns <span class="nb">exec</span> qrouter-e521f9d0-a1bd-4ff4-bc81-78a60dd88fe5 ip a <span class="p">|</span> grep state
<span class="go">10: qr-e6256f7d-31: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue</span>
<span class="go">    state UNKNOWN</span>
<span class="go">11: qg-35916e1f-36: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500</span>
<span class="go">    qdisc pfifo_fast state UNKNOWN qlen 500</span>
<span class="go">28: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN</span>
</pre></div>
</div>
</li>
<li><p class="first">The <code class="docutils literal"><span class="pre">qg-&lt;n&gt;</span></code> interface in the l3-agent router namespace sends the
packet on to its next hop through device <code class="docutils literal"><span class="pre">eth2</span></code> on the external
bridge <code class="docutils literal"><span class="pre">br-ex</span></code>. This bridge is constructed similarly to <code class="docutils literal"><span class="pre">br-eth1</span></code>
and may be inspected in the same way.</p>
</li>
<li><p class="first">This external bridge also includes a physical network interface,
<code class="docutils literal"><span class="pre">eth2</span></code> in this example, which finally lands the packet on the
external network destined for an external router or destination.</p>
</li>
<li><p class="first">DHCP agents running on OpenStack networks run in namespaces similar
to the l3-agents. DHCP namespaces are named <code class="docutils literal"><span class="pre">qdhcp-&lt;uuid&gt;</span></code> and have
a TAP device on the integration bridge. Debugging of DHCP issues
usually involves working inside this network namespace.</p>
</li>
</ol>
</div>
<div class="section" id="finding-a-failure-in-the-path">
<h2>Finding a Failure in the Path<a class="headerlink" href="#finding-a-failure-in-the-path" title="Permalink to this headline">¶</a></h2>
<p>Use ping to quickly find where a failure exists in the network path. In
an instance, first see whether you can ping an external host, such as
google.com. If you can, then there shouldn&#8217;t be a network problem at
all.</p>
<p>If you can&#8217;t, try pinging the IP address of the compute node where the
instance is hosted. If you can ping this IP, then the problem is
somewhere between the compute node and that compute node&#8217;s gateway.</p>
<p>If you can&#8217;t ping the IP address of the compute node, the problem is
between the instance and the compute node. This includes the bridge
connecting the compute node&#8217;s main NIC with the vnet NIC of the
instance.</p>
<p>One last test is to launch a second instance and see whether the two
instances can ping each other. If they can, the issue might be related
to the firewall on the compute node.</p>
</div>
<div class="section" id="tcpdump">
<h2>tcpdump<a class="headerlink" href="#tcpdump" title="Permalink to this headline">¶</a></h2>
<p>One great, although very in-depth, way of troubleshooting network issues
is to use <code class="docutils literal"><span class="pre">tcpdump</span></code>. We recommended using <code class="docutils literal"><span class="pre">tcpdump</span></code> at several
points along the network path to correlate where a problem might be. If
you prefer working with a GUI, either live or by using a <code class="docutils literal"><span class="pre">tcpdump</span></code>
capture, check out
<a class="reference external" href="http://www.wireshark.org/">Wireshark</a>.</p>
<p>For example, run the following command:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> tcpdump -i any -n -v <span class="s1">&#39;icmp[icmptype] = icmp-echoreply or icmp[icmptype] = icmp-echo&#39;</span>
</pre></div>
</div>
<p>Run this on the command line of the following areas:</p>
<ol class="arabic simple">
<li>An external server outside of the cloud</li>
<li>A compute node</li>
<li>An instance running on that compute node</li>
</ol>
<p>In this example, these locations have the following IP addresses:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">Instance</span>
<span class="go">    10.0.2.24</span>
<span class="go">    203.0.113.30</span>
<span class="go">Compute Node</span>
<span class="go">    10.0.0.42</span>
<span class="go">    203.0.113.34</span>
<span class="go">External Server</span>
<span class="go">    1.2.3.4</span>
</pre></div>
</div>
<p>Next, open a new shell to the instance and then ping the external host
where <code class="docutils literal"><span class="pre">tcpdump</span></code> is running. If the network path to the external server
and back is fully functional, you see something like the following:</p>
<p>On the external server:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">12:51:42.020227 IP (tos 0x0, ttl 61, id 0, offset 0, flags [DF],</span>
<span class="go">proto ICMP (1), length 84)</span>
<span class="go">    203.0.113.30 &gt; 1.2.3.4: ICMP echo request, id 24895, seq 1, length 64</span>
<span class="go">12:51:42.020255 IP (tos 0x0, ttl 64, id 8137, offset 0, flags [none],</span>
<span class="go">proto ICMP (1), length 84)</span>
<span class="go">    1.2.3.4 &gt; 203.0.113.30: ICMP echo reply, id 24895, seq 1,</span>
<span class="go">    length 64</span>
</pre></div>
</div>
<p>On the compute node:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">12:51:42.019519 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF],</span>
<span class="go">proto ICMP (1), length 84)</span>
<span class="go">    10.0.2.24 &gt; 1.2.3.4: ICMP echo request, id 24895, seq 1, length 64</span>
<span class="go">12:51:42.019519 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF],</span>
<span class="go">proto ICMP (1), length 84)</span>
<span class="go">    10.0.2.24 &gt; 1.2.3.4: ICMP echo request, id 24895, seq 1, length 64</span>
<span class="go">12:51:42.019545 IP (tos 0x0, ttl 63, id 0, offset 0, flags [DF],</span>
<span class="go">proto ICMP (1), length 84)</span>
<span class="go">    203.0.113.30 &gt; 1.2.3.4: ICMP echo request, id 24895, seq 1, length 64</span>
<span class="go">12:51:42.019780 IP (tos 0x0, ttl 62, id 8137, offset 0, flags [none],</span>
<span class="go">proto ICMP (1), length 84)</span>
<span class="go">    1.2.3.4 &gt; 203.0.113.30: ICMP echo reply, id 24895, seq 1, length 64</span>
<span class="go">12:51:42.019801 IP (tos 0x0, ttl 61, id 8137, offset 0, flags [none],</span>
<span class="go">proto ICMP (1), length 84)</span>
<span class="go">    1.2.3.4 &gt; 10.0.2.24: ICMP echo reply, id 24895, seq 1, length 64</span>
<span class="go">12:51:42.019807 IP (tos 0x0, ttl 61, id 8137, offset 0, flags [none],</span>
<span class="go">proto ICMP (1), length 84)</span>
<span class="go">    1.2.3.4 &gt; 10.0.2.24: ICMP echo reply, id 24895, seq 1, length 64</span>
</pre></div>
</div>
<p>On the instance:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">12:51:42.020974 IP (tos 0x0, ttl 61, id 8137, offset 0, flags [none],</span>
<span class="go">proto ICMP (1), length 84)</span>
<span class="go"> 1.2.3.4 &gt; 10.0.2.24: ICMP echo reply, id 24895, seq 1, length 64</span>
</pre></div>
</div>
<p>Here, the external server received the ping request and sent a ping
reply. On the compute node, you can see that both the ping and ping
reply successfully passed through. You might also see duplicate packets
on the compute node, as seen above, because <code class="docutils literal"><span class="pre">tcpdump</span></code> captured the
packet on both the bridge and outgoing interface.</p>
</div>
<div class="section" id="iptables">
<h2>iptables<a class="headerlink" href="#iptables" title="Permalink to this headline">¶</a></h2>
<p>Through <code class="docutils literal"><span class="pre">nova-network</span></code> or <code class="docutils literal"><span class="pre">neutron</span></code>, OpenStack Compute automatically
manages iptables, including forwarding packets to and from instances on
a compute node, forwarding floating IP traffic, and managing security
group rules. In addition to managing the rules, comments (if supported)
will be inserted in the rules to help indicate the purpose of the rule.</p>
<p>The following comments are added to the rule set as appropriate:</p>
<ul class="simple">
<li>Perform source NAT on outgoing traffic.</li>
<li>Default drop rule for unmatched traffic.</li>
<li>Direct traffic from the VM interface to the security group chain.</li>
<li>Jump to the VM specific chain.</li>
<li>Direct incoming traffic from VM to the security group chain.</li>
<li>Allow traffic from defined IP/MAC pairs.</li>
<li>Drop traffic without an IP/MAC allow rule.</li>
<li>Allow DHCP client traffic.</li>
<li>Prevent DHCP Spoofing by VM.</li>
<li>Send unmatched traffic to the fallback chain.</li>
<li>Drop packets that are not associated with a state.</li>
<li>Direct packets associated with a known session to the RETURN chain.</li>
<li>Allow IPv6 ICMP traffic to allow RA packets.</li>
</ul>
<p>Run the following command to view the current iptables configuration:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> iptables-save
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you modify the configuration, it reverts the next time you
restart <code class="docutils literal"><span class="pre">nova-network</span></code> or <code class="docutils literal"><span class="pre">neutron-server</span></code>. You must use
OpenStack to manage iptables.</p>
</div>
</div>
<div class="section" id="network-configuration-in-the-database-for-nova-network">
<h2>Network Configuration in the Database for nova-network<a class="headerlink" href="#network-configuration-in-the-database-for-nova-network" title="Permalink to this headline">¶</a></h2>
<p>With <code class="docutils literal"><span class="pre">nova-network</span></code>, the nova database table contains a few tables
with networking information:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">fixed_ips</span></code></dt>
<dd>Contains each possible IP address for the subnet(s) added to
Compute. This table is related to the <code class="docutils literal"><span class="pre">instances</span></code> table by way of
the <code class="docutils literal"><span class="pre">fixed_ips.instance_uuid</span></code> column.</dd>
<dt><code class="docutils literal"><span class="pre">floating_ips</span></code></dt>
<dd>Contains each floating IP address that was added to Compute. This
table is related to the <code class="docutils literal"><span class="pre">fixed_ips</span></code> table by way of the
<code class="docutils literal"><span class="pre">floating_ips.fixed_ip_id</span></code> column.</dd>
<dt><code class="docutils literal"><span class="pre">instances</span></code></dt>
<dd>Not entirely network specific, but it contains information about the
instance that is utilizing the <code class="docutils literal"><span class="pre">fixed_ip</span></code> and optional
<code class="docutils literal"><span class="pre">floating_ip</span></code>.</dd>
</dl>
<p>From these tables, you can see that a floating IP is technically never
directly related to an instance; it must always go through a fixed IP.</p>
<div class="section" id="manually-disassociating-a-floating-ip">
<h3>Manually Disassociating a Floating IP<a class="headerlink" href="#manually-disassociating-a-floating-ip" title="Permalink to this headline">¶</a></h3>
<p>Sometimes an instance is terminated but the floating IP was not
correctly disassociated from that instance. Because the database is in
an inconsistent state, the usual tools to disassociate the IP no longer
work. To fix this, you must manually update the database.</p>
<p>First, find the UUID of the instance in question:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">uuid</span> <span class="k">from</span> <span class="n">instances</span> <span class="k">where</span> <span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;hostname&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>Next, find the fixed IP entry for that UUID:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">fixed_ips</span> <span class="k">where</span> <span class="n">instance_uuid</span> <span class="o">=</span> <span class="s1">&#39;&lt;uuid&gt;&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>You can now get the related floating IP entry:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">floating_ips</span> <span class="k">where</span> <span class="n">fixed_ip_id</span> <span class="o">=</span> <span class="s1">&#39;&lt;fixed_ip_id&gt;&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>And finally, you can disassociate the floating IP:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">update</span> <span class="n">floating_ips</span> <span class="kt">set</span> <span class="n">fixed_ip_id</span> <span class="o">=</span> <span class="no">NULL</span><span class="p">,</span> <span class="n">host</span> <span class="o">=</span> <span class="no">NULL</span> <span class="k">where</span>
       <span class="n">fixed_ip_id</span> <span class="o">=</span> <span class="s1">&#39;&lt;fixed_ip_id&gt;&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>You can optionally also deallocate the IP from the user&#8217;s pool:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">update</span> <span class="n">floating_ips</span> <span class="kt">set</span> <span class="n">project_id</span> <span class="o">=</span> <span class="no">NULL</span> <span class="k">where</span>
       <span class="n">fixed_ip_id</span> <span class="o">=</span> <span class="s1">&#39;&lt;fixed_ip_id&gt;&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="debugging-dhcp-issues-with-nova-network">
<h2>Debugging DHCP Issues with nova-network<a class="headerlink" href="#debugging-dhcp-issues-with-nova-network" title="Permalink to this headline">¶</a></h2>
<p>One common networking problem is that an instance boots successfully but
is not reachable because it failed to obtain an IP address from dnsmasq,
which is the DHCP server that is launched by the <code class="docutils literal"><span class="pre">nova-network</span></code>
service.</p>
<p>The simplest way to identify that this is the problem with your instance
is to look at the console output of your instance. If DHCP failed, you
can retrieve the console log by doing:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack console log show &lt;instance name or uuid&gt;
</pre></div>
</div>
<p>If your instance failed to obtain an IP through DHCP, some messages
should appear in the console. For example, for the Cirros image, you see
output that looks like the following:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">udhcpc (v1.17.2) started</span>
<span class="go">Sending discover...</span>
<span class="go">Sending discover...</span>
<span class="go">Sending discover...</span>
<span class="go">No lease, forking to background</span>
<span class="go">starting DHCP forEthernet interface eth0 [ [1;32mOK[0;39m ]</span>
<span class="go">cloud-setup: checking http://169.254.169.254/2009-04-04/meta-data/instance-id</span>
<span class="go">wget: can&#39;t connect to remote host (169.254.169.254): Network is</span>
<span class="go">unreachable</span>
</pre></div>
</div>
<p>After you establish that the instance booted properly, the task is to
figure out where the failure is.</p>
<p>A DHCP problem might be caused by a misbehaving dnsmasq process. First,
debug by checking logs and then restart the dnsmasq processes only for
that project (tenant). In VLAN mode, there is a dnsmasq process for each
tenant. Once you have restarted targeted dnsmasq processes, the simplest
way to rule out dnsmasq causes is to kill all of the dnsmasq processes
on the machine and restart <code class="docutils literal"><span class="pre">nova-network</span></code>. As a last resort, do this
as root:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> killall dnsmasq
<span class="gp">#</span> restart nova-network
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use <code class="docutils literal"><span class="pre">openstack-nova-network</span></code> on RHEL/CentOS/Fedora but
<code class="docutils literal"><span class="pre">nova-network</span></code> on Ubuntu/Debian.</p>
</div>
<p>Several minutes after <code class="docutils literal"><span class="pre">nova-network</span></code> is restarted, you should see new
dnsmasq processes running:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ps aux <span class="p">|</span> grep dnsmasq
<span class="go">nobody 3735 0.0 0.0 27540 1044 ? S 15:40 0:00 /usr/sbin/dnsmasq --strict-order</span>
<span class="go">    --bind-interfaces --conf-file=</span>
<span class="go">    --domain=novalocal --pid-file=/var/lib/nova/networks/nova-br100.pid</span>
<span class="go">    --listen-address=192.168.100.1 --except-interface=lo</span>
<span class="go">    --dhcp-range=set:&#39;novanetwork&#39;,192.168.100.2,static,120s</span>
<span class="go">    --dhcp-lease-max=256</span>
<span class="go">    --dhcp-hostsfile=/var/lib/nova/networks/nova-br100.conf</span>
<span class="go">    --dhcp-script=/usr/bin/nova-dhcpbridge --leasefile-ro</span>
<span class="go">root 3736 0.0 0.0 27512 444 ? S 15:40 0:00 /usr/sbin/dnsmasq --strict-order</span>
<span class="go">     --bind-interfaces --conf-file=</span>
<span class="go">     --domain=novalocal --pid-file=/var/lib/nova/networks/nova-br100.pid</span>
<span class="go">     --listen-address=192.168.100.1 --except-interface=lo</span>
<span class="go">     --dhcp-range=set:&#39;novanetwork&#39;,192.168.100.2,static,120s</span>
<span class="go">     --dhcp-lease-max=256</span>
<span class="go">     --dhcp-hostsfile=/var/lib/nova/networks/nova-br100.conf</span>
<span class="go">     --dhcp-script=/usr/bin/nova-dhcpbridge --leasefile-ro</span>
</pre></div>
</div>
<p>If your instances are still not able to obtain IP addresses, the next
thing to check is whether dnsmasq is seeing the DHCP requests from the
instance. On the machine that is running the dnsmasq process, which is
the compute host if running in multi-host mode, look at
<code class="docutils literal"><span class="pre">/var/log/syslog</span></code> to see the dnsmasq output. If dnsmasq is seeing the
request properly and handing out an IP, the output looks like this:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">Feb 27 22:01:36 mynode dnsmasq-dhcp[2438]: DHCPDISCOVER(br100) fa:16:3e:56:0b:6f</span>
<span class="go">Feb 27 22:01:36 mynode dnsmasq-dhcp[2438]: DHCPOFFER(br100) 192.168.100.3</span>
<span class="go">                                           fa:16:3e:56:0b:6f</span>
<span class="go">Feb 27 22:01:36 mynode dnsmasq-dhcp[2438]: DHCPREQUEST(br100) 192.168.100.3</span>
<span class="go">                                           fa:16:3e:56:0b:6f</span>
<span class="go">Feb 27 22:01:36 mynode dnsmasq-dhcp[2438]: DHCPACK(br100) 192.168.100.3</span>
<span class="go">                                           fa:16:3e:56:0b:6f test</span>
</pre></div>
</div>
<p>If you do not see the <code class="docutils literal"><span class="pre">DHCPDISCOVER</span></code>, a problem exists with the packet
getting from the instance to the machine running dnsmasq. If you see all
of the preceding output and your instances are still not able to obtain
IP addresses, then the packet is able to get from the instance to the
host running dnsmasq, but it is not able to make the return trip.</p>
<p>You might also see a message such as this:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">Feb 27 22:01:36 mynode dnsmasq-dhcp[25435]: DHCPDISCOVER(br100)</span>
<span class="go">            fa:16:3e:78:44:84 no address available</span>
</pre></div>
</div>
<p>This may be a dnsmasq and/or <code class="docutils literal"><span class="pre">nova-network</span></code> related issue. (For the
preceding example, the problem happened to be that dnsmasq did not have
any more IP addresses to give away because there were no more fixed IPs
available in the OpenStack Compute database.)</p>
<p>If there&#8217;s a suspicious-looking dnsmasq log message, take a look at the
command-line arguments to the dnsmasq processes to see if they look
correct:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ps aux <span class="p">|</span> grep dnsmasq
</pre></div>
</div>
<p>The output looks something like the following:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">108 1695 0.0 0.0 25972 1000 ? S Feb26 0:00 /usr/sbin/dnsmasq</span>
<span class="go"> -u libvirt-dnsmasq</span>
<span class="go"> --strict-order --bind-interfaces</span>
<span class="go"> --pid-file=/var/run/libvirt/network/default.pid --conf-file=</span>
<span class="go"> --except-interface lo --listen-address 192.168.122.1</span>
<span class="go"> --dhcp-range 192.168.122.2,192.168.122.254</span>
<span class="go"> --dhcp-leasefile=/var/lib/libvirt/dnsmasq/default.leases</span>
<span class="go"> --dhcp-lease-max=253 --dhcp-no-override</span>
<span class="go">nobody 2438 0.0 0.0 27540 1096 ? S Feb26 0:00 /usr/sbin/dnsmasq</span>
<span class="go"> --strict-order --bind-interfaces --conf-file=</span>
<span class="go"> --domain=novalocal --pid-file=/var/lib/nova/networks/nova-br100.pid</span>
<span class="go"> --listen-address=192.168.100.1</span>
<span class="go"> --except-interface=lo</span>
<span class="go"> --dhcp-range=set:&#39;novanetwork&#39;,192.168.100.2,static,120s</span>
<span class="go"> --dhcp-lease-max=256</span>
<span class="go"> --dhcp-hostsfile=/var/lib/nova/networks/nova-br100.conf</span>
<span class="go"> --dhcp-script=/usr/bin/nova-dhcpbridge --leasefile-ro</span>
<span class="go">root 2439 0.0 0.0 27512 472 ? S Feb26 0:00 /usr/sbin/dnsmasq --strict-order</span>
<span class="go"> --bind-interfaces --conf-file=</span>
<span class="go"> --domain=novalocal --pid-file=/var/lib/nova/networks/nova-br100.pid</span>
<span class="go"> --listen-address=192.168.100.1</span>
<span class="go"> --except-interface=lo</span>
<span class="go"> --dhcp-range=set:&#39;novanetwork&#39;,192.168.100.2,static,120s</span>
<span class="go"> --dhcp-lease-max=256</span>
<span class="go"> --dhcp-hostsfile=/var/lib/nova/networks/nova-br100.conf</span>
<span class="go"> --dhcp-script=/usr/bin/nova-dhcpbridge --leasefile-ro</span>
</pre></div>
</div>
<p>The output shows three different dnsmasq processes. The dnsmasq process
that has the DHCP subnet range of 192.168.122.0 belongs to libvirt and
can be ignored. The other two dnsmasq processes belong to
<code class="docutils literal"><span class="pre">nova-network</span></code>. The two processes are actually related—one is simply
the parent process of the other. The arguments of the dnsmasq processes
should correspond to the details you configured <code class="docutils literal"><span class="pre">nova-network</span></code> with.</p>
<p>If the problem does not seem to be related to dnsmasq itself, at this
point use <code class="docutils literal"><span class="pre">tcpdump</span></code> on the interfaces to determine where the packets
are getting lost.</p>
<p>DHCP traffic uses UDP. The client sends from port 68 to port 67 on the
server. Try to boot a new instance and then systematically listen on the
NICs until you identify the one that isn&#8217;t seeing the traffic. To use
<code class="docutils literal"><span class="pre">tcpdump</span></code> to listen to ports 67 and 68 on br100, you would do:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> tcpdump -i br100 -n port <span class="m">67</span> or port 68
</pre></div>
</div>
<p>You should be doing sanity checks on the interfaces using command such
as <strong class="command">ip a</strong> and <strong class="command">brctl show</strong> to ensure that the interfaces are
actually up and configured the way that you think that they are.</p>
</div>
<div class="section" id="debugging-dns-issues">
<h2>Debugging DNS Issues<a class="headerlink" href="#debugging-dns-issues" title="Permalink to this headline">¶</a></h2>
<p>If you are able to use <a class="reference internal" href="common/glossary.html#term-secure-shell-ssh"><span class="xref std std-term">SSH</span></a> to log into an
instance, but it takes a very long time (on the order of a minute) to get
a prompt, then you might have a DNS issue. The reason a DNS issue can cause
this problem is that the SSH server does a reverse DNS lookup on the
IP address that you are connecting from. If DNS lookup isn&#8217;t working on your
instances, then you must wait for the DNS reverse lookup timeout to occur for
the SSH login process to complete.</p>
<p>When debugging DNS issues, start by making sure that the host where the
dnsmasq process for that instance runs is able to correctly resolve. If
the host cannot resolve, then the instances won&#8217;t be able to either.</p>
<p>A quick way to check whether DNS is working is to resolve a hostname
inside your instance by using the <strong class="command">host</strong> command. If DNS is working,
you should see:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> host openstack.org
<span class="go">openstack.org has address 174.143.194.225</span>
<span class="go">openstack.org mail is handled by 10 mx1.emailsrvr.com.</span>
<span class="go">openstack.org mail is handled by 20 mx2.emailsrvr.com.</span>
</pre></div>
</div>
<p>If you&#8217;re running the Cirros image, it doesn&#8217;t have the &#8220;host&#8221; program
installed, in which case you can use ping to try to access a machine by
hostname to see whether it resolves. If DNS is working, the first line
of ping would be:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ping openstack.org
<span class="go">PING openstack.org (174.143.194.225): 56 data bytes</span>
</pre></div>
</div>
<p>If the instance fails to resolve the hostname, you have a DNS problem.
For example:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ping openstack.org
<span class="go">ping: bad address &#39;openstack.org&#39;</span>
</pre></div>
</div>
<p>In an OpenStack cloud, the dnsmasq process acts as the DNS server for
the instances in addition to acting as the DHCP server. A misbehaving
dnsmasq process may be the source of DNS-related issues inside the
instance. As mentioned in the previous section, the simplest way to rule
out a misbehaving dnsmasq process is to kill all the dnsmasq processes
on the machine and restart <code class="docutils literal"><span class="pre">nova-network</span></code>. However, be aware that this
command affects everyone running instances on this node, including
tenants that have not seen the issue. As a last resort, as root:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> killall dnsmasq
<span class="gp">#</span> restart nova-network
</pre></div>
</div>
<p>After the dnsmasq processes start again, check whether DNS is working.</p>
<p>If restarting the dnsmasq process doesn&#8217;t fix the issue, you might need
to use <code class="docutils literal"><span class="pre">tcpdump</span></code> to look at the packets to trace where the failure is.
The DNS server listens on UDP port 53. You should see the DNS request on
the bridge (such as, br100) of your compute node. Let&#8217;s say you start
listening with <code class="docutils literal"><span class="pre">tcpdump</span></code> on the compute node:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> tcpdump -i br100 -n -v udp port 53
<span class="go">tcpdump: listening on br100, link-type EN10MB (Ethernet), capture size 65535 bytes</span>
</pre></div>
</div>
<p>Then, if you use SSH to log into your instance and try <code class="docutils literal"><span class="pre">ping</span> <span class="pre">openstack.org</span></code>,
you should see something like:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">16:36:18.807518 IP (tos 0x0, ttl 64, id 56057, offset 0, flags [DF],</span>
<span class="go"> proto UDP (17), length 59)</span>
<span class="go"> 192.168.100.4.54244 &gt; 192.168.100.1.53: 2+ A? openstack.org. (31)</span>
<span class="go">16:36:18.808285 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF],</span>
<span class="go"> proto UDP (17), length 75)</span>
<span class="go"> 192.168.100.1.53 &gt; 192.168.100.4.54244: 2 1/0/0 openstack.org. A</span>
<span class="go"> 174.143.194.225 (47)</span>
</pre></div>
</div>
</div>
<div class="section" id="troubleshooting-open-vswitch">
<h2>Troubleshooting Open vSwitch<a class="headerlink" href="#troubleshooting-open-vswitch" title="Permalink to this headline">¶</a></h2>
<p>Open vSwitch, as used in the previous OpenStack Networking examples is a
full-featured multilayer virtual switch licensed under the open source
Apache 2.0 license. Full documentation can be found at <a class="reference external" href="http://openvswitch.org/">the project&#8217;s
website</a>. In practice, given the preceding
configuration, the most common issues are being sure that the required
bridges (<code class="docutils literal"><span class="pre">br-int</span></code>, <code class="docutils literal"><span class="pre">br-tun</span></code>, and <code class="docutils literal"><span class="pre">br-ex</span></code>) exist and have the
proper ports connected to them.</p>
<p>The Open vSwitch driver should and usually does manage this
automatically, but it is useful to know how to do this by hand with the
<strong class="command">ovs-vsctl</strong> command. This command has many more subcommands than we
will use here; see the man page or use <strong class="command">ovs-vsctl --help</strong> for the
full listing.</p>
<p>To list the bridges on a system, use <strong class="command">ovs-vsctl list-br</strong>.
This example shows a compute node that has an internal
bridge and a tunnel bridge. VLAN networks are trunked through the
<code class="docutils literal"><span class="pre">eth1</span></code> network interface:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-vsctl list-br
<span class="go">br-int</span>
<span class="go">br-tun</span>
<span class="go">eth1-br</span>
</pre></div>
</div>
<p>Working from the physical interface inwards, we can see the chain of
ports and bridges. First, the bridge <code class="docutils literal"><span class="pre">eth1-br</span></code>, which contains the
physical network interface <code class="docutils literal"><span class="pre">eth1</span></code> and the virtual interface
<code class="docutils literal"><span class="pre">phy-eth1-br</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-vsctl list-ports eth1-br
<span class="go">eth1</span>
<span class="go">phy-eth1-br</span>
</pre></div>
</div>
<p>Next, the internal bridge, <code class="docutils literal"><span class="pre">br-int</span></code>, contains <code class="docutils literal"><span class="pre">int-eth1-br</span></code>, which
pairs with <code class="docutils literal"><span class="pre">phy-eth1-br</span></code> to connect to the physical network shown in
the previous bridge, <code class="docutils literal"><span class="pre">patch-tun</span></code>, which is used to connect to the GRE
tunnel bridge and the TAP devices that connect to the instances
currently running on the system:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-vsctl list-ports br-int
<span class="go">int-eth1-br</span>
<span class="go">patch-tun</span>
<span class="go">tap2d782834-d1</span>
<span class="go">tap690466bc-92</span>
<span class="go">tap8a864970-2d</span>
</pre></div>
</div>
<p>The tunnel bridge, <code class="docutils literal"><span class="pre">br-tun</span></code>, contains the <code class="docutils literal"><span class="pre">patch-int</span></code> interface and
<code class="docutils literal"><span class="pre">gre-&lt;N&gt;</span></code> interfaces for each peer it connects to via GRE, one for
each compute and network node in your cluster:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ovs-vsctl list-ports br-tun
<span class="go">patch-int</span>
<span class="go">gre-1</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">gre-&lt;N&gt;</span>
</pre></div>
</div>
<p>If any of these links are missing or incorrect, it suggests a
configuration error. Bridges can be added with <code class="docutils literal"><span class="pre">ovs-vsctl</span> <span class="pre">add-br</span></code>,
and ports can be added to bridges with
<code class="docutils literal"><span class="pre">ovs-vsctl</span> <span class="pre">add-port</span></code>. While running these by hand can be useful
debugging, it is imperative that manual changes that you intend to keep
be reflected back into your configuration files.</p>
</div>
<div class="section" id="dealing-with-network-namespaces">
<span id="id1"></span><h2>Dealing with Network Namespaces<a class="headerlink" href="#dealing-with-network-namespaces" title="Permalink to this headline">¶</a></h2>
<p>Linux network namespaces are a kernel feature the networking service
uses to support multiple isolated layer-2 networks with overlapping IP
address ranges. The support may be disabled, but it is on by default. If
it is enabled in your environment, your network nodes will run their
dhcp-agents and l3-agents in isolated namespaces. Network interfaces and
traffic on those interfaces will not be visible in the default
namespace.</p>
<p>To see whether you are using namespaces, run <strong class="command">ip netns</strong>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ip netns
<span class="go">qdhcp-e521f9d0-a1bd-4ff4-bc81-78a60dd88fe5</span>
<span class="go">qdhcp-a4d00c60-f005-400e-a24c-1bf8b8308f98</span>
<span class="go">qdhcp-fe178706-9942-4600-9224-b2ae7c61db71</span>
<span class="go">qdhcp-0a1d0a27-cffa-4de3-92c5-9d3fd3f2e74d</span>
<span class="go">qrouter-8a4ce760-ab55-4f2f-8ec5-a2e858ce0d39</span>
</pre></div>
</div>
<p>L3-agent router namespaces are named <code class="docutils literal"><span class="pre">qrouter-&lt;router_uuid&gt;</span></code>, and
dhcp-agent name spaces are named <code class="docutils literal"><span class="pre">qdhcp-&lt;net_uuid&gt;</span></code>. This output
shows a network node with four networks running dhcp-agents, one of
which is also running an l3-agent router. It&#8217;s important to know which
network you need to be working in. A list of existing networks and their
UUIDs can be obtained by running <code class="docutils literal"><span class="pre">neutron</span> <span class="pre">net-list</span></code> with administrative
credentials.</p>
<p>Once you&#8217;ve determined which namespace you need to work in, you can use
any of the debugging tools mention earlier by prefixing the command with
<code class="docutils literal"><span class="pre">ip</span> <span class="pre">netns</span> <span class="pre">exec</span> <span class="pre">&lt;namespace&gt;</span></code>. For example, to see what network
interfaces exist in the first qdhcp namespace returned above, do this:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ip netns <span class="nb">exec</span> qdhcp-e521f9d0-a1bd-4ff4-bc81-78a60dd88fe5 ip a
<span class="go">10: tape6256f7d-31: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN</span>
<span class="go">    link/ether fa:16:3e:aa:f7:a1 brd ff:ff:ff:ff:ff:ff</span>
<span class="go">    inet 10.0.1.100/24 brd 10.0.1.255 scope global tape6256f7d-31</span>
<span class="go">    inet 169.254.169.254/16 brd 169.254.255.255 scope global tape6256f7d-31</span>
<span class="go">    inet6 fe80::f816:3eff:feaa:f7a1/64 scope link</span>
<span class="go">    valid_lft forever preferred_lft forever</span>
<span class="go">28: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN</span>
<span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
<span class="go">    inet 127.0.0.1/8 scope host lo</span>
<span class="go">    inet6 ::1/128 scope host</span>
<span class="go">    valid_lft forever preferred_lft forever</span>
</pre></div>
</div>
<p>From this you see that the DHCP server on that network is using the
<code class="docutils literal"><span class="pre">tape6256f7d-31</span></code> device and has an IP address of <code class="docutils literal"><span class="pre">10.0.1.100</span></code>.
Seeing the address <code class="docutils literal"><span class="pre">169.254.169.254</span></code>, you can also see that the
dhcp-agent is running a metadata-proxy service. Any of the commands
mentioned previously in this chapter can be run in the same way.
It is also possible to run a shell, such as <code class="docutils literal"><span class="pre">bash</span></code>, and have an
interactive session within the namespace. In the latter case,
exiting the shell returns you to the top-level default namespace.</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>The authors have spent too much time looking at packet dumps in order to
distill this information for you. We trust that, following the methods
outlined in this chapter, you will have an easier time. Aside from
working with the tools and steps above, don&#8217;t forget that sometimes an
extra pair of eyes goes a long way to assist.</p>
</div>
</div>


              </div>
            </div>
          </div>
          <div class="docs-actions">
          
            <a href="ops-uninstall.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Uninstalling"></i></a>
          
          
            <a href="ops-logging-monitoring.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Logging and Monitoring"></i></a>
          
            <a id="logABugLink3" href="#" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
          </div>
          <div class="row docs-byline bottom">
            <div class="docs-updated">updated: 2016-12-30 18:30</div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8 docs-license">
<a href="https://creativecommons.org/licenses/by/3.0/">
 <img src="_static/images/docs/license.png" alt="Creative Commons Attribution 3.0 License"/>
</a>
<p>
 Except where otherwise noted, this document is licensed under
 <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons
 Attribution 3.0 License</a>. See all <a href="http://www.openstack.org/legal">
 OpenStack Legal Documents</a>.
</p>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 docs-actions-wrapper">
            <!-- ID buglinkbottom added so that pre-filled doc bugs
                 are sent to Launchpad projects related to the document -->
              <a href="#" id="logABugLink2" class="docs-footer-actions"><i class="fa fa-bug"></i> found an error? report a bug</a>
              <a href="http://ask.openstack.org/" class="docs-footer-actions"><i class="fa fa-question-circle"></i> questions?</a>
            </div>
          </div>
        </div>
<div class="col-lg-3 col-md-4 col-sm-4 col-lg-pull-9 col-md-pull-8 col-sm-pull-8 docs-sidebar">
  <div class="search-icon show">
    <i class="fa fa-search"></i> Search
  </div>
  <div class="btn-group docs-sidebar-releases">
    <button onclick="location.href='http://docs.openstack.org/'" class="btn docs-sidebar-home" data-toggle="tooltip" data-placement="top" title="Docs Home"><i class="fa fa-arrow-circle-o-left"></i></button>
<button href="#" type="button" data-toggle="dropdown" class="btn docs-sidebar-release-select">OpenStack Documentation<i class="fa fa-caret-down"></i></button>
    <ul class="dropdown-menu docs-sidebar-dropdown" role="menu" aria-labelledby="dLabel">
      <li role="presentation" class="dropdown-header">Guides</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#install-guides">Install Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#user-guides">User Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#configuration-guides">Configuration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#ops-and-admin-guides">Operations and Administration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#api-guides">API Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#contributor-guides">Contributor Guides</a></li>
      <li role="presentation" class="dropdown-header">Languages</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ja/">日本語 (Japanese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/de/">Deutsch (German)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/fr/">Français (French)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/pt_BR/">Português (Portuguese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/zh_CN/">简体中文 (Simplified Chinese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ko_KR/">한국어 (Korean)</a></li>
    </ul>
  </div>
  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="table-of-contents">
      <a href="index-2.html" class="docs-sidebar-section-title"><h4>Contents</h4></a>
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="common/conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="operations.html">Operations</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ops-lay-of-the-land.html">Lay of the Land</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-projects-users.html">Managing Projects and Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-user-facing-operations.html">User-Facing Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-maintenance.html">Maintenance, Failures, and Debugging</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Network Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-logging-monitoring.html">Logging and Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-backup-recovery.html">Backup and Recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-customize.html">Customization</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-advanced-configuration.html">Advanced Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-upgrades.html">Upgrades</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="app-usecases.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="app-crypt.html">Tales From the Cryp^H^H^H^H Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="app-roadmaps.html">Working with Roadmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="app-resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="common/app-support.html">Community support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="common/glossary.html">Glossary</a></li>
</ul>

    </div>
  </div>
</div>
      </div>
    </div>
<footer>
  <div class="container">
    <div class="row footer-links">
      <div class="col-lg-2 col-sm-2">
        <h3>OpenStack</h3>
        <ul>
          <li><a href="http://openstack.org/projects/">Projects</a></li>
          <li><a href="http://openstack.org/projects/openstack-security/">OpenStack Security</a></li>
          <li><a href="http://openstack.org/projects/openstack-faq/">Common Questions</a></li>
          <li><a href="http://openstack.org/blog/">Blog</a></li>
          <li><a href="http://openstack.org/news/">News</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Community</h3>
        <ul>
          <li><a href="http://openstack.org/community/">User Groups</a></li>
          <li><a href="http://openstack.org/community/events/">Events</a></li>
          <li><a href="http://openstack.org/community/jobs/">Jobs</a></li>
          <li><a href="http://openstack.org/foundation/companies/">Companies</a></li>
          <li><a href="http://docs.openstack.org/infra/manual/developers.html">Contribute</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Documentation</h3>
        <ul>
          <li><a href="http://docs.openstack.org/">OpenStack Manuals</a></li>
          <li><a href="http://openstack.org/software/start/">Getting Started</a></li>
          <li><a href="http://developer.openstack.org/">API Documentation</a></li>
          <li><a href="https://wiki.openstack.org/">Wiki</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Branding & Legal</h3>
        <ul>
          <li><a href="http://openstack.org/brand/">Logos & Guidelines</a></li>
          <li><a href="http://openstack.org/brand/openstack-trademark-policy/">Trademark Policy</a></li>
          <li><a href="http://openstack.org/privacy/">Privacy Policy</a></li>
          <li><a href="https://wiki.openstack.org/wiki/How_To_Contribute#Contributor_License_Agreement">OpenStack CLA</a></li>
        </ul>
      </div>
      <div class="col-lg-4 col-sm-4">
        <h3>Stay In Touch</h3>
        <a href="https://twitter.com/OpenStack" target="_blank" class="social-icons footer-twitter"></a>
        <a href="https://www.facebook.com/openstack" target="_blank" class="social-icons footer-facebook"></a>
        <a href="https://www.linkedin.com/company/openstack" target="_blank" class="social-icons footer-linkedin"></a>
        <a href="https://www.youtube.com/user/OpenStackFoundation" target="_blank" class="social-icons footer-youtube"></a>
        <p class="fine-print">
          The OpenStack project is provided under the
          <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>. Openstack.org is powered by
          <a href="http://rackspace.com/" target="_blank">Rackspace Cloud Computing</a>.
        </p>
      </div>
    </div>
  </div>
</footer>
<!-- jQuery -->
<script type="text/javascript" src="_static/js/jquery-1.11.3.js"></script>

<!-- Bootstrap JavaScript -->
<script type="text/javascript" src="_static/js/bootstrap.min.js"></script>

<!-- The rest of the JS -->
<script type="text/javascript" src="_static/js/navigation.js"></script>

<!-- Docs JS -->
<script type="text/javascript" src="_static/js/docs.js"></script>

<!-- Popovers -->
<script type="text/javascript" src="_static/js/webui-popover.js"></script>

<!-- Javascript for page -->
<script language="JavaScript">
/* build a description of this page including SHA, source location on git repo,
   build time and the project's launchpad bug tag. Set the HREF of the bug
   buttons */

    var lineFeed = "%0A";
    var gitURL = "Source: Can't derive source file URL";

    /* there have been cases where "pagename" wasn't set; better check for it */
        /* The URL of the source file on Git is based on the giturl variable
           in conf.py, which must be manually initialized to the source file
           URL in Git.
           "pagename" is a standard sphinx parameter containing the name of
           the source file, without extension.                             */

        var sourceFile = "ops-network-troubleshooting" + ".rst";
        gitURL = "Source: http://git.openstack.org/cgit/openstack/openstack-manuals/tree/doc/ops-guide/source" + "/" + sourceFile;

    /* gitsha, project and bug_tag rely on variables in conf.py */
    var gitSha = "SHA: 522e4919f8db2885f022e41fa599c8c3056b8485";
        var bugProject = "openstack-manuals";
        var bugTitle = "Network Troubleshooting in Operations Guide";
    var fieldTags = "ops-guide";

    /* "last_updated" is the build date and time. It relies on the
       conf.py variable "html_last_updated_fmt", which should include
       year/month/day as well as hours and minutes                   */
    var buildstring = "Release: 0.0.1 on 2016-12-30 18:30";

    var fieldComment = encodeURI(buildstring) +
                       lineFeed + encodeURI(gitSha) +
                       lineFeed + encodeURI(gitURL) ;

    logABug(bugTitle, bugProject, fieldComment, fieldTags);
</script>

<!-- Javascript for search boxes (both sidebar and top nav) -->
<script type="text/javascript">
(function() {
var cx = '000108871792296872333:noj9nikm74i';
var gcse = document.createElement('script');
gcse.type = 'text/javascript';
gcse.async = true;
gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
'//www.google.com/cse/cse.js?cx=' + cx;
var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(gcse, s);
})();
</script>

  </body>

<!-- Mirrored from docs.openstack.org/ops-guide/ops-network-troubleshooting.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Jan 2017 09:36:53 GMT -->
</html>